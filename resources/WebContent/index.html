<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<title>DbxTune - Central</title>

  <!-- 
    =======================================================================
    == JS imports - JAVA SCRIPTS GOES HERE
    =======================================================================
  -->
  <!-- JS: JQuery -->
  <script type="text/javascript" src="/scripts/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/scripts/jquery/ui/1.11.3/jquery-ui.min.js"></script>

  <!-- JS: Moment; used by: ChartJs, DateRangePicker -->
  <script type="text/javascript" src="/scripts/moment/moment.js"></script>
  <script type="text/javascript" src="/scripts/moment/moment-duration-format.js"></script>

  <!-- JS: Bootstrap -->
  <script type="text/javascript" src="/scripts/popper/1.12.9/popper.min.js"></script>
  <script type="text/javascript" src="/scripts/bootstrap/js/bootstrap.min.js"></script>

  <!-- JS: Selectize -->
  <script type="text/javascript" src="/scripts/selectize/js/standalone/selectize.js"></script>
  
  <!-- JS: DbxCentral -->
  <script type="text/javascript" src="/scripts/dbxcentral.utils.js"></script>

  <!-- 
    =======================================================================
    == CSS imports - STYLES SHEETS GOES HERE
    =======================================================================
  -->
  <!-- CSS: DbxCentral -->
  <link rel="stylesheet" href="/scripts/css/dbxcentral.css">

  <!-- CSS: Bootstrap -->
  <link rel="stylesheet" href="/scripts/bootstrap/css/bootstrap.min.css">

  <!-- CSS: Font Awsome -->
  <link rel="stylesheet" href="/scripts/font-awesome/4.4.0/css/font-awesome.min.css">

  <!-- CSS: Selectize -->
  <!-- <link rel="stylesheet" href="/scripts/selectize/css/selectize.css"> -->
  <!-- <link rel="stylesheet" href="/scripts/selectize/css/selectize.default.css"> -->
  <!-- <link rel="stylesheet" href="/scripts/selectize/css/selectize.bootstrap3.css"> -->
  <link rel="stylesheet" href="/scripts/selectize/css/selectize.default.css">
 
  <!-- Local CSS -->
  <style type='text/css'>
    /* table {border-collapse: collapse;}
    th, td {border: 1px solid black; text-align: left; padding: 2px;}
    tr:nth-child(even) {background-color: #f2f2f2;} */
    .dbx-quick-access-tooltip-table table {border-collapse: collapse;}
    .dbx-quick-access-tooltip-table th, td {border: 1px solid white; text-align: left; padding: 2px;}

    .tooltip-inner { max-width: 1000px; }

    .jumbotron{ margin-top:-30px; }

    #active-alarms-top {
      position: fixed;
      color: rgba(255, 148, 20, 1.0);
      top: 10px;
	  font-size: 24px;
      left: 40%;
	  z-index: 9999;
	  animation: blink 1.5s infinite;
	}
    @keyframes blink 
    {  
      0% { opacity: 1.0; }
      50% { opacity: 0.0; }
      100% { opacity: 1.0; }
    }

    #active-alarms {
      position: fixed;
      bottom: 0;
      max-height: 30%;
      width: 100%;
      overflow: auto;
      /* background-color: rgb(255, 195, 83); */
      background-color: rgba(255, 195, 83, 0.5);
    }

	#active-alarms-ctl {
      position: -webkit-sticky; /* Safari */
      position: sticky;
      top: 0;
      left: 0;
	}

	.dbx-topHr {
		border-top: 1px solid black;
		margin-bottom:6px;
	}
    
	/* selectize selected items */
	.ui-sortable-handle {
		width: 100%;
	}
	.selectize-dropdown, .selectize-dropdown.form-control{
		height: 35vh !important;
	}
	.selectize-dropdown-content{
		max-height: 100% !important;
		height: 100% !important;
	}

  </style>

</head>

<body>
  <!-- NavBar that works, except for: iphone... -->
  <nav class="navbar navbar-expand-md navbar-dark sticky-top bg-dark mb-0">
    <a class="navbar-brand" href="/">DbxCentral</a>
    <!-- <a class="navbar-brand" href="#"><img style="	width: 32px;" src="images/dbxcentral_32.png">DbxCentral</a> -->
    <!-- <a class="navbar-brand" href="#"><img style="	width: 16px;" src="images/dbxcentral_16.png">DbxCentral</a> -->
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarCollapse">
      <ul class="navbar-nav mr-auto">
        <li class="nav-item">
          <a class="nav-link" href="/overview">Servers<span class="sr-only">(current)</span></a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/admin/admin.html">Admin</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/desktop_app.html">Desktop App</a>
        </li>
      </ul>
	  <!-- on the right hand side of the menu... -->
      <ul class="navbar-nav">
	    <!-- IS LOGGED IN -->
        <div id="dbx-nb-isLoggedIn-div" style="display: none;">
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="http://example.com" id="navbarDropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              <i class="fa fa-user"></i> <span id="dbx-nb-isLoggedInUser-div"></span> <!-- current username will be in here -->
            </a>
            <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdownMenuLink">
            <a class="dropdown-item" href="#"> <i class="fa fa-cog"></i> Settings [not-yet-implemented]</a>
            <a class="dropdown-item" href="/logout"> <i class="fa fa-sign-out"></i> Logout</a>
            </div>
          </li>
        </div>
	    <!-- IS LOGGED OUT -->
        <div id="dbx-nb-isLoggedOut-div">
          <a class="nav-link" href="/index.html?login"> <i class="fa fa-sign-in"></i> <span data-toggle="tooltip" title="Log in as a specific user.">Login</span></a>
        </div>
      </ul> <!-- end right hand side -->
    </div>
  </nav>
  
  <!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   - - Basic info + "QUICK ACCESS" buttons to server graphs...
   - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->
  <main role="main" class="container">
    <div class="jumbotron">
      <h1>DbxTune - Central</h1>
      <p class="lead">View Trends Graphs for all your Database Systems in one place!</p>
      <!-- <p class="lead">View all your DBMS trends graphs in a centralized console.</p> -->
      <!-- <p class="lead">DbxTune Central is the component where all DbxTune collectors can send summary data so it can be easely viewed...</p> -->
      <div id="dbx-image">
        <p><img id="example-graph" src="images/dbxcentral_graph_example.png" alt="Example Graph"></p>
        <p align="right"><font size="-2">Support for: Sybase/SAP: ASE, IQ, <i>RS, RAX, MS SQL-Server, Postgres, MySQL, DB2, Oracle, SAP HANA</i></font></p>
      </div>

      <div id="x"> <!-- So we can "skip" the top image in an easy way -->
        <button type="button" class="btn btn-lg btn-primary btn-ok" data-toggle="modal" data-backdrop="static" data-target="#dbx-choose-graphs-dialog">View charts &raquo;</button>
        &nbsp;&nbsp;&nbsp;<span id="dbx-alarm-cnt">0</span> Active Alams<span id="dbx-alarm-srv-cnt">, in 0 Servers.</span> <span id="dbx-alarm-age">0</span> seconds ago. Click <a href='?refresh=60'>here</a> to refresh every 60 seconds
      </div>
      <p></p>
      <p>
        <input type="checkbox" name="dbx-openInNewTab-chk" id="dbx-openInNewTab-chk" checked> Open Below Graphs in a new Tab &nbsp;&nbsp;&nbsp;
        <input type="checkbox" name="dbx-graphCsDark-chk"  id="dbx-graphCsDark-chk"  checked> In Dark Theme &nbsp;&nbsp;&nbsp;
        <input type="checkbox" name="dbx-showDbxImage-chk" id="dbx-showDbxImage-chk" checked> <i>Show Above Chart Image</i><br>
        <input type="checkbox" name="dbx-subscribe-chk"    id="dbx-subscribe-chk"    checked> Automatically Update Graphs when new data arrives from Collectors<br>
		 Display Last <input type="text" name="dbx-hours-txt" id="dbx-hours-txt" style="height:20px;width:30px" size="3" value="2"> Hours when Opening Graphs. &nbsp;&nbsp;&nbsp;
		 Using <input type="text" name="dbx-gcols-txt" id="dbx-gcols-txt" style="height:20px;width:30px" size="3" value="#" title='default "x" means: Depends on the screen size: small[15"]=1, medium[24"]=2 or large[27"]=3'> Graph Columns<br>
	  </p>
	  
<!--      &#10148; Quick access list (show system selected graphs)-->
      &#10148; Choose Action on the Dropdown for each Server
      <div id="dbx-quick-access-server-list">
        <a class="btn btn-sm btn-primary mb-2" href="/graph.html?subscribe=true&startTime=2h&sessionName=DUMMY_ASE" role="button">Loading server list <i class='fa fa-spinner fa-spin '></i></a>
      </div>

<!--
      &#10148; Quick access list (show <b>all</b> available graphs)
      <div id="dbx-quick-access-server-all-list">
        <a class="btn btn-sm btn-primary mb-2" href="/graph.html?subscribe=true&startTime=2h&sessionName=DUMMY_ASE&graphList=all" role="button">Loading server list <i class='fa fa-spinner fa-spin '></i></a>
      </div>
-->

      <br>
      &#10148; Profiles
      <div id="dbx-quick-access-profile-list">
<!--        <a class="btn btn-sm btn-primary mb-2" data-toggle="tooltip" title="Open a dialog where you can create 'Profiles', which will be displayed to the left of this button." href="/admin/new-profile" role="button">New Profile...</a>-->
        <button type="button" class="btn btn-sm btn-primary mb-2 btn-ok" data-toggle="modal" data-backdrop="static" data-target="#dbx-choose-graphs-dialog">New Profile...</button>
      </div>
      <!-- Error message: browser support -->
      <div id="browser-not-supported"></div>
    </div>
  </main>

  
  <!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   - - Modal Dialog: Choose Graphs to Display
   - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->
  <div class="modal fade" id="dbx-choose-graphs-dialog" tabindex="-1" role="dialog" aria-labelledby="dbx-choose-graphs-dialog" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="dbx-choose-graphs-dialog-title">Choose Graphs to Display</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          Choose any Server(s) and Graph(s) you want to view
          <ul>
            <li><b>Add Graphs</b> - Click the 'Add...' button, or select the input field, then type what you search for...<br>
              &rarr; You can use many words; like: <code>servername category etc...</code>
            </li>
            <li><b>Remove a graph</b> - Simply press the 'x' on the Graph Item</li>
            <li><b>Reorder graph display order</b> - Do <i>drag & drop</i></li>
          </ul>

          <input type="text" id="dbx-choose-graphs-input" class="demo-default" placeholder="Type to Search...">
          <span id="dbx-choose-graphs-dialog-select-cnt">X</span> Graphs selected, <span id="dbx-choose-graphs-dialog-available-cnt">Y</span> available Graphs
          <span>
            <button type="button" class="btn btn-default btn-sm btn-add">Add...</button>
            <button type="button" class="btn btn-default btn-sm btn-clear">Clear</button>
          </span>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary mr-auto btn-saveAsProfile" id="dbx-saveAsProfile-btn" data-toggle="modal" data-backdrop="static" data-target="#dbx-saveAsNewProfile-dialog">Save as new Profile...</button>

          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary btn-ok">View Graphs</button>
        </div>
      </div>
    </div>
  </div>  

  <!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   - - Modal Dialog: Save as new Profile (called from "Choose Graphs to Display")
   - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->
  <div class="modal fade" id="dbx-saveAsNewProfile-dialog" tabindex="-1" role="dialog" aria-labelledby="dbx-saveAsNewProfile-dialog" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
      <div class="modal-content">
        <!--https://www.codeply.com/go/ryhBsmqTkB/bootstrap-4-validation-example-->
        <!--https://mdbootstrap.com/docs/jquery/forms/validation/-->
<!--        <form class="container needs-validation" novalidate id="dbx-saveAsNewProfile-form" onsubmit="return saveAsNewProfileSubmit();">-->
        <form class="container needs-validation" novalidate id="dbx-saveAsNewProfile-form" onsubmit="return false;">
          <div class="modal-header">
            <h5 class="modal-title" id="dbx-saveAsNewProfile-dialog-title">Save as New Profile</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <b>Save current Graph Selection as a Profile, that will be visible at the start page</b>
            <br>
			<br>

            <div class="form-group">
              <label class="form-control-label" for="dbx-fld-profileName">Profile Name</label>
              <input type="text" class="form-control" name="profileName" id="dbx-fld-profileName" placeholder="Name of the Profile, which will be the button label" value="" required />
              <div class="invalid-feedback">Name must be specified!</div>
            </div>
            <div class="form-group">
              <label class="form-control-label" for="dbx-fld-profileDesc">Profile Descrption</label>
              <input type="text" class="form-control" name="profileDesciption" id="dbx-fld-profileDesc" placeholder="Describe the profile, shows up in tooltip" value="" required />
              <div class="invalid-feedback">A Description must be specified!</div>
            </div>
            <div class="form-group">
              <label class="form-control-label" for="dbx-fld-urlOpt">URL Options</label>
              <input type="text" class="form-control" name="profileUrlOptions" id="dbx-fld-urlOpt" placeholder="Other properties passed to the graph.html page, example: gcols=3" value="" />
              <div class="valid-feedback"></div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            <button type="submit" class="btn btn-primary btn-ok">Save</button>
          </div>
        </form>
      </div>
    </div>
  </div>  


  <!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   - - Modal Dialog: LOGIN
   - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->
  <div id="dbx-login-dialog" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
              <div class="modal-header">
                  <!--<h3><i class="fa fa-sign-in"></i> DbxCentral - Login</h3>-->
                  <h3>DbxCentral - Login</h3>
                  <button type="button" class="close" data-dismiss="modal" aria-hidden="true">Ã—</button>
              </div>
              <form class="form" role="form" autocomplete="off" id="dbx-login-form" novalidate="" method="POST" action="j_security_check">
                  <div class="modal-body">
                      <div class="form-group">
                          <a href="" class="float-right">Create New User (not-yet-impl)</a>

                          <label for="dbx-login-user-txt">Username</label>
                          <span class="fa fa-question-circle" data-toggle="tooltip" data-placement="bottom" data-html="true" title="The default 'admin' user is <code>admin</code><br>With the password <code>ip-address</code> where DbxcCentral is running or <code>admin</code>.<br>Check DxcCentral's error log, where the password is written in case no password has been specified for the admin user, search  for ADMIN_USER_PASSWORD<br><br>But hopefully it has been changed on this system :)">&nbsp;</span>
                          <input type="text" class="form-control" name="j_username" id="dbx-login-user-txt" required="">
                          <div class="invalid-feedback">Oops, you missed this one.</div>
                      </div>
                      <div class="form-group">
                          <a href="" class="float-right">Forgot password? (not-yet-impl)</a>

                          <labelfor="dbx-login-passwd-txt">Password</label>
                          <input type="password" class="form-control" name="j_password" id="dbx-login-passwd-txt" required="" autocomplete="new-password">
                          <div class="invalid-feedback">Enter your password too!<br>Default 'admin' password is IP Address of the DbxCentral hostname.</div>
                      </div>
                      <!-- Adding a hidden submit field here, enables: submit on RETURN on any of the input fields, if fields have not been filled in, then the validation will show what's wrong -->  
                      <input type="submit" hidden />

                      <!--
                      <div class="custom-control custom-checkbox">
                        <input type="checkbox" class="custom-control-input" id="rememberMe">
                        <label class="custom-control-label" for="rememberMe">Remember me on this computer</label>
                      </div>
                      <div class="form-group py-4">
                          <button class="btn btn-outline-secondary" data-dismiss="modal" aria-hidden="true">Cancel</button>
                          <button type="submit" class="btn btn-success float-right" id="dbx-login-btn">Login</button>
                      </div>
                      -->
                      <div id="dbx-loginFailed-div" class="custom-control" style="display: none;">
                        <b><font color="red">Login failed!</font></b>
                      </div>
                  </div>
                  <div class="modal-footer">
                      <button class="btn btn-outline-secondary" data-dismiss="modal" aria-hidden="true">Cancel</button>
                      <button type="submit" class="btn btn-success float-right" id="dbx-login-btn">Login</button>
                  </div>
              </form>
          </div>
      </div>
  </div>
<!-- 
<h1>DbxTune - Central</h1>

List of stuff that can be done
<ul>
  <li> <a href='/graph_subscribe.html'>  Test Chart/Graph broadcast (Google Charts)</a> </li>
  <li> <a href='/graph.html'> Test Chart/Graph broadcast (JS Chart)     </a> </li>
  <li> <a href='overview'           > Overview of Alarms and Recordings </a> </li>
  <li> <a href='admin'              > Admin this central instance </a> </li>
  <li> <a href='not-yet-implemented'> View online and historical performance charts for the monitored servers </a> </li>
  <li> <a href='not-yet-implemented'> Download the native/desktop AseTune application</a> </li>
</ul>
<a href="dummyfile.txt">dummyfile.txt</a>
 -->

<!-- Show Active alarms -->
<div id="active-alarms-top" style="visibility: hidden;">
Active Alarms
</div>

<div id="active-alarms" class="active-alarms-class" style="visibility: hidden;">
    <div id="active-alarms-ctl" class="active-alarms-ctl-class">
        There are <span id="active-alarms-count" style="color:red">##</span> Active Alarms...&nbsp;&nbsp;&nbsp; Alarm Window Max Size: 
		<input type="radio" name="active-alarms-show-radio" id="active-alarms-show-radio-10" onclick="activeAlarmsRadioClick(this);" value="10%"        > 10%
		<input type="radio" name="active-alarms-show-radio" id="active-alarms-show-radio-30" onclick="activeAlarmsRadioClick(this);" value="30%" checked> 30%
		<input type="radio" name="active-alarms-show-radio" id="active-alarms-show-radio-60" onclick="activeAlarmsRadioClick(this);" value="60%"        > 60%
		<input type="radio" name="active-alarms-show-radio" id="active-alarms-show-radio-95" onclick="activeAlarmsRadioClick(this);" value="95%"        > 95%
		<input type="radio" name="active-alarms-show-radio" id="active-alarms-show-radio-0"  onclick="activeAlarmsRadioClick(this);" value="hide"       > Minimize &nbsp;&nbsp;&nbsp;
		<input type="checkbox" name="active-alarms-solid-chk" id="active-alarms-solid-chk"   onclick="activeAlarmsChkClick(this);"   value="solid"> Solid Background &nbsp;&nbsp;&nbsp;
		<input type="checkbox" name="active-alarms-compExtDesc-chk" id="active-alarms-compExtDesc-chk"   onclick="activeAlarmsCompExtDescClick(this);" title="Show Extended Descriptions Columns as HTML Formated or as 'Plain Text'"  value="compExtDesc" checked> Extended Descriptions as Plain Text
    </div>
    <div id="active-alarms-win" class="active-alarms-win-class">
    </div>
</div>

<!-- Just add some blank lines for scrolling purposes -->
<br><br><br><br><br><br><br><br><br><br><br><br>
<br><br><br><br><br><br><br><br><br><br><br><br>
<br><br><br><br><br><br><br><br><br><br><br><br>
<br><br><br><br><br><br><br><br><br><br><br><br>


<script>
	// Do we support the browser...
	// Get version of MS: IE or Edge
	// IE or EDGE are not supported
	var ieVersion = detectIE();
	if (ieVersion !== false) 
	{
		var browserVersion = ((ieVersion >= 12) ? 'Edge ' : 'IE ') + ieVersion;
		document.getElementById('browser-not-supported').innerHTML = "<br><br>Current Browser: <b>" + browserVersion + "</b> isn't that well tested. If you have issues use: Chrome, Firefox or Safari";
		if (ieVersion < 12)
		{
			document.getElementById('browser-not-supported').innerHTML = "<br><br><font color='red'>Current Browser: <b>" + browserVersion + "</b> is not supported. Please use Chrome, Firefox or Safari</font>";
			// alert("Current Browser: " + browserVersion + " is not supported. Please use Chrome, Firefox or Safari");
			// return;
		}
	}

	//-----------------------------------------------------------
	// get input parameters
	//-----------------------------------------------------------
	var _refresh = getParameter("refresh", 300);
	var _debug   = getParameter("debug",   0);

	console.log("_refresh="+_refresh);
	console.log("_debug="  +_debug);


	function resizeExampleImage() {
		// Origin size is: 378
		var exampleImage = document.getElementById("example-graph");
		// console.log("exampleImageSize="+exampleImage.style.height+", browser.height="+$(window).height());
		if ($(window).height() >  1152) exampleImage.style.height = '';//'378px';
		if ($(window).height() <= 1024) exampleImage.style.height = '300px';
		if ($(window).height() <=  768) exampleImage.style.height = '200px';
		// console.log("exampleImageSize="+exampleImage.style.height+", browser.height="+$(window).height());
	}

	window.addEventListener("resize", function() {
		resizeExampleImage();
	});
	resizeExampleImage();


	//-----------------------------------------------------------
	// Store/restore checkbox values
	//-----------------------------------------------------------
	// a key must is used for the cookie/storage
	var storedData = getStorage('dbxtune_checkboxes_');

	// Remember CHECKBOX fields
//	$('div.check input:checkbox').bind('change',function(){
	$('input[type=checkbox]').bind('change',function(){
		$('#'+this.id+'txt').toggle($(this).is(':checked'));
		// save the data on change
		storedData.set(this.id, $(this).is(':checked')?'checked':'not');
	}).each(function() {
		// on load, set the value to what we read from storage:
		var val = storedData.get(this.id);
		if (val == 'checked') $(this).attr('checked', 'checked');
		if (val == 'not') $(this).removeAttr('checked');
		if (val) $(this).trigger('change');
	});

	// Remember TEXT fields
	$('input[type=text]').bind('change',function(){
		// save the data on change
		storedData.set(this.id, $(this).val());
	}).each(function() {
		// on load, set the value to what we read from storage:
		var val = storedData.get(this.id);
		if (val){
			$(this).val(val);
			$(this).trigger('change');
		}
	});

	// Remember RADIO fields
//	$('input[type=radio]').bind('change',function(){
//		// save the data on change
//		storedData.set(this.id, $(this).val());
//	}).each(function() {
//		// on load, set the value to what we read from storage:
//		var val = storedData.get(this.id);
//		if (val){
//			$(this).val(val);
//			$(this).trigger('change');
//		}
//	});


	// Hide top "example dbx chart"
	const showExampleImage = $('#dbx-showDbxImage-chk') .is(":checked");
	if ( ! showExampleImage )
	{
		$("#dbx-image").css("display", "none");
	}
	// Action: when pressing checkbox
	$("#dbx-showDbxImage-chk").click(function() 
	{
		location.reload();
	});


	//-----------------------------------------------------------
	// ACTIVE ALARMS
	//-----------------------------------------------------------
	function radionButtonGroupSetSelectedValue(name, selectdValue) 
	{
		console.log("radionButtonGroupSetSelectedValue(): name="+name+", selectedValue="+selectdValue);
		$('input[name="' + name+ '"][value="' + selectdValue + '"]').prop('checked', true);
	}

	function activeAlarmsRadioClick(radioBut) 
	{
		var rVal = typeof(radioBut) == "string" ? radioBut : radioBut.value;
		console.log('activeAlarmsRadioClick(): Active Alarm Window Size[RadioBut]: ' + rVal);
		
		if (rVal === "hide")
		{
			// Hide all Alarms
			$("#active-alarms-win").css("display", "none");
		}
		else
		{
			// Set The OUTER max-size
			$("#active-alarms").css("max-height", rVal);

			// SHOW all Alarms
			$("#active-alarms-win").css("display", "block");
		}

		// Save last known value in "WebBrowser storage"
		getStorage('dbxtune_checkboxes_').set("active-alarms-show-radio", rVal);
	}
	function activeAlarmsChkClick(checkbox) 
	{
		console.log('activeAlarmsChkClick(): Checked: ' + checkbox.checked);
		if (checkbox.checked)
		{
			$("#active-alarms").css("background-color", 'rgba(255, 195, 83, 1.0)');
		}
		else
		{
			$("#active-alarms").css("background-color", 'rgba(255, 195, 83, 0.5)');
		}

		// Save last known value in "WebBrowser storage"
		getStorage('dbxtune_checkboxes_').set("active-alarms-solid-chk", checkbox.checked ? 'checked' : 'not');
	}
	function activeAlarmsCompExtDescClick(checkbox) 
	{
		console.log('activeAlarmsCompExtDescClick(): Checked: ' + checkbox.checked);

		// Save last known value in "WebBrowser storage"
		getStorage('dbxtune_checkboxes_').set("active-alarms-compExtDesc-chk", checkbox.checked ? 'checked' : 'not');

		// Reload the page
		//location.reload();
		
		toggleActiveAlarmsExtendedDesciption();
	}
	
	// do: deferred (since all DOM elements might not be created yet)
	setTimeout(function()
	{
		// Restore 'Compact Extended Desc' at the ACTIVE ALARMS "window"
		var savedVal_activeAlarmsCompactExtDescChk = getStorage('dbxtune_checkboxes_').get("active-alarms-compExtDesc-chk");
		if (savedVal_activeAlarmsCompactExtDescChk == 'checked') $("#active-alarms-compExtDesc-chk").attr('checked', 'checked');
		if (savedVal_activeAlarmsCompactExtDescChk == 'not')     $("#active-alarms-compExtDesc-chk").removeAttr('checked');
		//activeAlarmsCompExtDescClick( document.getElementById("active-alarms-compExtDesc-chk") );

		// Restore 'Solid Background' at the ACTIVE ALARMS "window"
		var savedVal_activeAlarmsSolidChk = getStorage('dbxtune_checkboxes_').get("active-alarms-solid-chk");
		if (savedVal_activeAlarmsSolidChk == 'checked') $("#active-alarms-solid-chk").attr('checked', 'checked');
		if (savedVal_activeAlarmsSolidChk == 'not')     $("#active-alarms-solid-chk").removeAttr('checked');
		activeAlarmsChkClick( document.getElementById("active-alarms-solid-chk") );

		// Restore 'Window Size' at the ACTIVE ALARMS "window"
		var savedVal_activeAlarmsShowRadio = getStorage('dbxtune_checkboxes_').get("active-alarms-show-radio");
		console.log("RESTORE ALARM Window size: savedVal_activeAlarmsShowRadio="+savedVal_activeAlarmsShowRadio);
		activeAlarmsRadioClick( savedVal_activeAlarmsShowRadio );
		radionButtonGroupSetSelectedValue("active-alarms-show-radio", savedVal_activeAlarmsShowRadio);
	}, 10);


	//-----------------------------------------------------------
	// CHOOSE GRAPHS DIALOG 
	//-----------------------------------------------------------
	$('#dbx-choose-graphs-dialog').on('click', '.btn-add', function(e) {
		var selectize = $('#dbx-choose-graphs-input').selectize()[0].selectize;
		selectize.open();
	});
	$('#dbx-choose-graphs-dialog').on('click', '.btn-clear', function(e) {
		var selectize = $('#dbx-choose-graphs-input').selectize()[0].selectize;
		selectize.clear();
		setGraphCountSelection();
	});
	$('#dbx-choose-graphs-dialog').on('click', '.btn-ok', function(e) {
		var modalDiv = $(e.delegateTarget);
//		var dbxProduct = $(this).data('recordId');
//		console.log("#dbx-choose-graphs-dialog: dbxProduct: "+dbxProduct);
//		modalDiv.addClass('working');

		var selectize = $('#dbx-choose-graphs-input').selectize()[0].selectize;
		var selectedItems = $.map(selectize.items, function(value) {
			return selectize.options[value].srvGraph;
		});
		console.log("#dbx-choose-graphs-dialog: selectedItems: "+selectedItems, selectedItems);
//		console.log("#dbx-choose-graphs-dialog: selectize.items: "+selectize.items, selectize.items);

//		// construct JSON TO continue with: [ {srv:"...", graph:"fullGraphName1"}, {srv:"...", graph:"fullGraphName2"}, {srv:"...", graph:"fullGraphName3"}... ]
//		var selectedJson = $.map(selectize.items, function(value) {
//			return { graph: value };
//		});
//		console.log("#dbx-choose-graphs-dialog: selectedJson: "+selectedJson, selectedJson);

		// Construct a new URL and open it in a new TAB
		var urlStr = "graph.html?subscribe=true&startTime=2h&graphList=" + encodeURIComponent(JSON.stringify(selectedItems));
		console.log("graph URL: "+urlStr);
		var win = window.open(urlStr, '_blank');
		win.focus();
		
		// Close the popup
		modalDiv.modal('hide').removeClass('working');
	});
	$('#dbx-choose-graphs-dialog').on('show.bs.modal', function(e) {
		var data = $(e.relatedTarget).data();
		var dbxProduct = data.recordId;

		console.log("#dbx-choose-graphs-dialog: dbxProduct: "+dbxProduct);
		var graphDesc1 = [];
		
		$.ajax(
		{
			url: "/api/graph/description",
			type: 'get',
			async: false,   // to call it one by one (async: true = spawn away a bunch of them in the background)

			success: function(data, status) 
			{
				// console.log("RECEIVED DATA: "+data);
				graphDesc1 = JSON.parse(data);
				//console.log("ajax.success(): new values for graphDesc1.", graphDesc1);
			},
			error: function(xhr, desc, err) 
			{
				console.log(xhr);
				console.log("Details: " + desc + "\nError: " + err);
			}
		}); // end: ajax call
		//console.log("AFTER: ajax.success(): new values for graphDesc1.", graphDesc1);

		// Transform JSON from: { AseTune: {SRV_1:[{...}], SRV_2:[{...}], SRV_3:[{...}]} }
		//                  to: { SRV_1:[{...,id:"SRV_1;CmSummary_aaCpuGraph"}], SRV_2:[{...}], SRV_3:[{...}]}
		var graphDesc2 = [];
//		var graphDesc2 = graphDesc1.map(graphDesc1, function(value) {
//			return graphDesc1[value];
//		});
//		let sspEntries = graphDesc1.map(a => a.tableName);
//		for (var i=0; i<graphDesc1.length; i++) {
//			var entry = graphDesc1[i];
//			console.log("XXX", entry);
//		}
		Object.keys(graphDesc1).forEach(function(dbxProdKey) {
			var srvEntry = graphDesc1[dbxProdKey];
			//console.log("dbxProdKey='"+dbxProdKey+"', srvEntry='"+srvEntry+"'.");

			Object.keys(srvEntry).forEach(function(srvKey) {
				if ( ! srvKey.startsWith("_") )
				{
					var gda = srvEntry[srvKey]; // gda = GraphDescriptionArray
					//console.log("srvKey='"+srvKey+"', gda='"+gda+"'.");

					Object.keys(gda).forEach(function(i) {
						var gd = gda[i]; // gd = GraphDescription
						gd.srvName = srvKey;
						gd.srvGraph = { srv: srvKey, graph: gd.tableName };
						gd.srvGraphStr = srvKey + "|" + gd.tableName;
						//console.log("i='"+i+"'.", gd);

						graphDesc2.push(gd);
					});
				}
			});
		});

		//console.log("AFTER: transform: graphDesc2.", graphDesc2);
		

		$('#dbx-choose-graphs-input').selectize()[0].selectize.destroy();
		$('#dbx-choose-graphs-input').selectize({
			plugins: ['drag_drop', 'remove_button'],
			create: false, // do not allow new entries
			persist: false,
			maxItems: null,
			valueField: 'srvGraphStr',
			searchField: ['srvName', 'dbxProduct', 'cmName', 'graphName', 'graphLabel', 'graphCategory'],
			options: graphDesc2,
//			options: ssp._ALL_,
//			items:   sspEntries,
			onItemAdd: function(value, item) {
				//console.log("onItemAdd()", value, item);
				setGraphCountSelection();
			},
			onItemRemove: function(value) {
				//console.log("onItemRemove()", value);
				setGraphCountSelection();
			},
			render: {
				item: function(item, escape) {
					//console.log("render.item()", item);
					return '<div>' +
						'<span>' + escape(item.srvName) + '@<i>'+escape(item.dbxProduct)+'</i></span>' +
						' - <span>' + escape(item.cmName) + '</span>' +
						' - <span>' + escape(item.graphName) + '</span>' +
						' - <span><i>' + escape(item.graphCategory) + '</span></i>' +
						'<br><span><b>' + escape(item.graphLabel) + '</b></span>' +
					'</div>';
				},
				option: function(item, escape) {
					//console.log("render.option()", item);
					return '<div class="dbx-topHr">' +
						'<span>' + escape(item.srvName) + '@<i>'+escape(item.dbxProduct)+'</i></span>' +
						' - <span>' + escape(item.cmName) + '</span>' +
						' - <span>' + escape(item.graphName) + '</span>' +
						' - <span><i>' + escape(item.graphCategory) + '</i></span>' +
						'<br><span><b>' + escape(item.graphLabel) + '</b></span>' +
					'</div>';
				}
			}
		});
//		$('#dbx-choose-graphs-input').selectize()[0].selectize.setValue(sspEntries);
//		$('#dbx-choose-graphs-input').selectize()[0].selectize.refreshOptions();
//		$('#dbx-choose-graphs-input').selectize()[0].selectize.refreshItems();

		setGraphCountSelection();

		$('.title', this).text(dbxProduct);
		$('.btn-ok', this).data('recordId', dbxProduct);
	});

	/**
	 * set "#dbx-choose-graphs-dialog-select-cnt" and "#dbx-choose-graphs-dialog-available-cnt"
	 */
	function setGraphCountSelection() 
	{
		let selectedItems   = $('#dbx-choose-graphs-input').selectize()[0].selectize.items.length;
		let availableItems  = $('#dbx-choose-graphs-input').selectize()[0].selectize.order;
		let unSelectedItems = availableItems - selectedItems;
	
		$("#dbx-choose-graphs-dialog-select-cnt")   .text( selectedItems );
		$("#dbx-choose-graphs-dialog-available-cnt").text( availableItems );
//		$("#dbx-choose-graphs-dialog-unselected-cnt").text( unSelectedItems );

		// Enable/Disable the "save as" button
		$("#dbx-saveAsProfile-btn").prop('disabled', selectedItems === 0);
	}

	//-----------------------------------------------------------
	// SAVE AS NEW PROFILE: DIALOG 
	//-----------------------------------------------------------
	(function()  // This was grabbed from https://mdbootstrap.com/docs/jquery/forms/validation/
	{
		'use strict';
		window.addEventListener('load', function() 
		{
			// Fetch all the forms we want to apply custom Bootstrap validation styles to
			var forms = document.getElementsByClassName('needs-validation');
			// Loop over them and prevent submission
			var validation = Array.prototype.filter.call(forms, function(form) 
			{
				form.addEventListener('submit', function(event) 
				{
					console.log("EventListener[submit]: .needs-validation: form.checkValidity()");
					if (form.checkValidity() === false) 
					{
						event.preventDefault();
						event.stopPropagation();
					}
					form.classList.add('was-validated');
					
					saveAsNewProfileSubmit(event);

				}, false);
			});
		}, false);
	})();

	function saveAsNewProfileSubmit(event)
	{
		// Fetch form to apply custom Bootstrap validation
		var form = $("#dbx-saveAsNewProfile-form");

		console.log("saveAsNewProfile(): OK was called");

		if (form[0].checkValidity() === false) 
		{
			console.log("#dbx-saveAsNewProfile-dialog: checkValidity -> NOT-VALID");
			event.preventDefault();
			event.stopPropagation();
		}
		else
		{
			console.log("#dbx-saveAsNewProfile-dialog: checkValidity -> OK");
			form.addClass('was-validated');

			var modalDiv = $(event.delegateTarget);
			modalDiv.addClass('working');

		//	console.log("#dbx-saveAsNewProfile-dialog: OK");
		//	alert("#dbx-saveAsNewProfile-dialog: OK: is NOT-YET-IMPLEMENTED");

			// Perform ajax submit here...
			var selectize = $('#dbx-choose-graphs-input').selectize()[0].selectize;
			var selectedItems = $.map(selectize.items, function(value) {
				return selectize.options[value].srvGraph;
			});
			console.log("#xxx: selectedItems: "+selectedItems, selectedItems);
			//var urlStr = "graph.html?subscribe=true&startTime=2h&graphList=" + encodeURIComponent(JSON.stringify(selectedItems));
			
			var sendObject = {
				productString:      "",
				userName:           "",
				profileName:        $("#dbx-fld-profileName").val(),
				profileDescription: $("#dbx-fld-profileDesc").val(),
				profileValue:       selectedItems,
				profileUrlOptions:  $("#dbx-fld-urlOpt").val()
				
			};
			console.log("#dbx-saveAsNewProfile-dialog: SEND_OBJ", sendObject);
			//alert("DEBUG!   ---READ The Console: to see what JSON To send to backend---");

			event.preventDefault();
			event.stopPropagation();
			
			console.log("POST /api/graph/profiles");
			$.ajax(
			{
				url: "/api/graph/profiles",
				type: 'POST',
				//async: false,   // to call it one by one (async: true = spawn away a bunch of them in the background)
				data: JSON.stringify(sendObject),
				contentType: "application/json; charset=UTF-8",

				success: function(data, status) 
				{
					console.log("SUCCESS: POST /api/graph/profiles: ", data, status);
					
					// console.log("RECEIVED DATA: "+data);
					//var jsonResp = JSON.parse(data);

					// Close the popup
					modalDiv.modal('hide').removeClass('working');

					// instead load the page from start... to reload the new Saved Profile(s)
					location.reload();
				},
				error: function(xhr, desc, err) 
				{
					console.log(xhr);
					console.log("Details: " + desc + "\nError: " + err);
				}
			}); // end: ajax call
		}
	}
//	$('#dbx-saveAsNewProfile-dialog').on('click', '.btn-ok', function(e) {
//		// Fetch form to apply custom Bootstrap validation
//		var form = $("#dbx-saveAsNewProfile-form");
//
//		console.log("#dbx-saveAsNewProfile-dialog: OK was pressed", e, form);
//
//		if (form[0].checkValidity() === false) 
//		{
//			console.log("#dbx-saveAsNewProfile-dialog: checkValidity -> NOT-VALID");
//			e.preventDefault();
//			e.stopPropagation();
//
//			form.addClass('is-invalid');
//		}
//		else
//		{
//			console.log("#dbx-saveAsNewProfile-dialog: checkValidity -> OK");
//			form.addClass('is-valid');
//			form.addClass('was-validated');
//
//			var modalDiv = $(e.delegateTarget);
//			modalDiv.addClass('working');
//
//			// Perform ajax submit here...
//			console.log("#dbx-saveAsNewProfile-dialog: OK");
//			alert("#dbx-saveAsNewProfile-dialog: OK: is NOT-YET-IMPLEMENTED");
//
//			var selectize = $('#dbx-choose-graphs-input').selectize()[0].selectize;
//			var selectedItems = $.map(selectize.items, function(value) {
//				return selectize.options[value].srvGraph;
//			});
//			console.log("#xxx: selectedItems: "+selectedItems, selectedItems);
//			//var urlStr = "graph.html?subscribe=true&startTime=2h&graphList=" + encodeURIComponent(JSON.stringify(selectedItems));
//			
//			var sendObject = {
//				productString:      "",
//				userName:           "",
//				profileName:        $("#dbx-fld-profileName").val(),
//				profileDescription: $("#dbx-fld-profileDesc").val(),
//				profileValue:       selectedItems,
//				profileUrlOptions:  $("#dbx-fld-urlOpt").val()
//				
//			};
//			console.log("#dbx-saveAsNewProfile-dialog: SEND_OBJ", sendObject);
//
//			// Do not load new page...
//			e.preventDefault();
//			e.stopPropagation();
//			// instead load the page from start... to reload the new Saved Profile(s)
////			location.reload();
//
//			// Close the popup
//			modalDiv.modal('hide').removeClass('working');
//		}
//	});
	$('#dbx-saveAsNewProfile-dialog').on('show.bs.modal', function(e) {
		console.log("#dbx-saveAsNewProfile-dialog: OPEN-MODAL");
	});



	//-----------------------------------------------------------
	// LOGIN - DIALOG 
	//-----------------------------------------------------------
//	$("#dbx-login-btn").click(function(event) {
	$("#dbx-login-form").submit(function(event) {
		console.log("dbx-login-form.SUBMIT.");
		//Fetch form to apply custom Bootstrap validation
		var form = $("#dbx-login-form")

		if (form[0].checkValidity() === false) {
			event.preventDefault()
			event.stopPropagation()
		}

		form.addClass('was-validated');
	});



//	//-----------------------------------------------------------
//	// get SERVERS
//	//-----------------------------------------------------------
//	$.ajax(
//	{
//		url: "/api/sessions",
//		type: 'get',
//		// async: false,   // to call it one by one (async: true = spawn away a bunch of them in the background)
//		
//		success: function(data, status) 
//		{
//			// console.log("RECEIVED DATA: "+data);
//			var jsonResp = JSON.parse(data);
//			
//			var htmlDropDown = "";
////			var html = "";
////			var htmlAll = "";
//			for (var i=0; i<jsonResp.length; i++) 
//			{
//				var entry = jsonResp[i];
//
//				if ((parseInt(entry.status) & 1) === 1) // 1=DISABLED
//				{
//					console.log("Skipping server '"+entry.serverName+"', since it's in DISABLED Status (status=1)");
//					continue;
//				}
//
//				var lastSampleTimeDuration = moment.duration(moment().diff(entry.lastSampleTime));
//				var lastSampleWarnThresh   = 5; // # minutes
//
//				var tt =
//				  "<table class='table table-sm'>"+
//				  "  <tr> <th nowrap colspan='2'>"+entry.serverDescription+"</th> </tr>"+
//				  "  <tr> <td nowrap>DBMS Server Name  </td> <td nowrap>"+ entry.serverName              +"</td> </tr>"+
//				  "  <tr> <td nowrap>DBMS On Hostname  </td> <td nowrap>"+ entry.onHostname              +"</td> </tr>"+
//				  "  <tr> <td nowrap>Collector         </td> <td nowrap>"+ entry.productString           +"</td> </tr>"+
//				  "  <tr> <td nowrap>Collector Hostname</td> <td nowrap>"+ entry.collectorHostname       +"</td> </tr>"+
//				  "  <tr> <td nowrap>Collector Interval</td> <td nowrap>"+ entry.collectorSampleInterval +"</td> </tr>"+
//				  "  <tr> <td nowrap>Last Sample       </td> <td nowrap>"+ moment(entry.lastSampleTime).format("YYYY-MM-DD HH:mm:ss") + (lastSampleTimeDuration.asMinutes() < lastSampleWarnThresh ? "" : ", <font color='red'>"+lastSampleTimeDuration.format()+"</font> since last sample" ) + "</td> </tr>"+
//				  "</table>";
//				  // The above tooltip didn't render that well (the table was wider than the "popup", which made it unreadable)
//				  // overide: .tooltip-inner { max-width: 1000px; } in the CSS and it worked better
//				  // tt = entry.serverDescription;
//
//				// set button class depending on how long ago since we got any sample for this server
//				var btnClass="btn-primary";
//				if (lastSampleTimeDuration.asMinutes() >= lastSampleWarnThresh)
//					btnClass="btn-warning";
//
//				var dbxButtonImage="dbx-button-image dbx-button-"+entry.productString.toLowerCase();
//		//		html    += '<a id="btn-qa-normal-'+entry.serverName+'" class="btn btn-sm '+btnClass+' '+dbxButtonImage+' mb-2 mr-2" role="button" data-toggle="tooltip" data-placement="top"    data-html="true" title="'+tt+'" href="/graph.html?subscribe=true&startTime=2h&sessionName='+entry.serverName+'">'+entry.serverName+'</a>';
//		//		htmlAll += '<a id="btn-qa-all-'   +entry.serverName+'" class="btn btn-sm '+btnClass+' '+dbxButtonImage+' mb-2 mr-2" role="button" data-toggle="tooltip" data-placement="bottom" data-html="true" title="'+tt+'" href="/graph.html?subscribe=true&startTime=2h&sessionName='+entry.serverName+'&graphList=all">'+entry.serverName+'</a>';
//
//		//		html    += '<span data-toggle="tooltip" data-placement="top"    data-html="true" title="'+tt+'"><button type="button" id="btn-qa-normal-'+entry.serverName+'" class="btn btn-sm '+btnClass+' '+dbxButtonImage+' mb-2 mr-2" onclick=\'return openGraphPage("server-ssp", "'+entry.serverName+'", "")\'>'+entry.serverName+'</button></span>';
//		//		htmlAll += '<span data-toggle="tooltip" data-placement="bottom" data-html="true" title="'+tt+'"><button type="button" id="btn-qa-all-'   +entry.serverName+'" class="btn btn-sm '+btnClass+' '+dbxButtonImage+' mb-2 mr-2" onclick=\'return openGraphPage("server-all", "'+entry.serverName+'", "")\'>'+entry.serverName+'</button></span>';
//
//				// Below is a LINK Button, so you can both do right click on the link to open, and click to open (using the properties: open-in-{here|tab}, time, subscribe)
//				const startTime = $('#dbx-hours-txt').val() + "h";
////				html    += '<a id="btn-qa-normal-'+entry.serverName+'" class="btn btn-sm '+btnClass+' '+dbxButtonImage+' mb-2 mr-2" role="button" data-toggle="tooltip" data-placement="top"    data-html="true" title="'+tt+'" href="/graph.html?subscribe=true&startTime='+startTime+'&sessionName='+entry.serverName+'"               onclick=\'return openGraphPage("server-ssp", "'+entry.serverName+'", "")\'>'+entry.serverName+'</a>';
////				htmlAll += '<a id="btn-qa-all-'   +entry.serverName+'" class="btn btn-sm '+btnClass+' '+dbxButtonImage+' mb-2 mr-2" role="button" data-toggle="tooltip" data-placement="bottom" data-html="true" title="'+tt+'" href="/graph.html?subscribe=true&startTime='+startTime+'&sessionName='+entry.serverName+'&graphList=all" onclick=\'return openGraphPage("server-all", "'+entry.serverName+'", "")\'>'+entry.serverName+'</a>';
//
//				htmlDropDown += ''
//				        + '<div class="btn-group">'
//				        + '  <button id="btn-qa-normal-'+entry.serverName+'" type="button" class="btn btn-sm '+btnClass+' '+dbxButtonImage+' mb-2 mr-2 dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">'
//				        + '    '+entry.serverName
//				        + '  </button>'
//				        + '  <div class="dropdown-menu">'
//				        + '    <a class="dropdown-item" href="/graph.html?subscribe=true&startTime='+startTime+'&sessionName='+entry.serverName+'"               onclick=\'return openGraphPage("server-ssp", "'+entry.serverName+'", "")\'>Show <b>System Selected</b> Graphs</a>'
//				        + '    <a class="dropdown-item" href="/graph.html?subscribe=true&startTime='+startTime+'&sessionName='+entry.serverName+'&graphList=all" onclick=\'return openGraphPage("server-all", "'+entry.serverName+'", "")\'>Show <b>ALL</b> Available Graphs</a>'
//				        + '    <div class="dropdown-divider"></div>'
//				        + '    <a class="dropdown-item" href="/report?op=viewLatest&name='+entry.serverName+'" target="_blank">Open <b>Latest</b> Daily Summary Report</a>'
//				        + '    <a class="dropdown-item" href="/overview#dsr-srv-'+entry.serverName+'" target="_blank">View <b>List</b> of <b>all</b> Daily Summary Report for this Server</a>'
//				        + '    <a class="dropdown-item" href="/overview?op=dsr-current-srv&srv='+entry.serverName+'" target="_blank"><b>Create</b> Daily Summary Report on Current Recording</a>'
//				        + '    <div class="dropdown-divider"></div>'
//				        + '    <a class="dropdown-item" href="/overview#offline-srv-'+entry.serverName+'" target="_blank">View <b>List</b> of all <b>Recordings</b> for this Server</a>'
//				        + '    <div class="dropdown-divider"></div>'
//				        + '    <a class="dropdown-item" href="/log?name='+entry.serverName+'.console&tail=5000" target="_blank"><b>Tail</b> Collector Console File</a>'
//				        + '    <div class="dropdown-divider"></div>'
//				        + '    <a class="dropdown-item" data-toggle="tooltip" data-placement="bottom" data-html="true" title="'+tt+'" href="#">Server <b>Info</b></a>'
//				        + '  </div>'
//				        + '</div>';
//			}
//			if (htmlDropDown === "")
//			{
//				htmlDropDown = '<button type="button" class="btn btn-sm btn-primary mb-2 mr-2">NO-SERVERS-HAS-YET-BEEN-ADDED</button>';
////				html    = '<button type="button" class="btn btn-sm btn-primary mb-2 mr-2">NO-SERVERS-HAS-YET-BEEN-ADDED</button>';
////				htmlAll = '<button type="button" class="btn btn-sm btn-primary mb-2 mr-2">NO-SERVERS-HAS-YET-BEEN-ADDED</button>';
//			}
////			$('#dbx-quick-access-server-list').html(html);
////			$('#dbx-quick-access-server-all-list').html(htmlAll);
//			$('#dbx-quick-access-server-list').html(htmlDropDown);
//
//			// Enable bootstrap tooltip...
//			$('[data-toggle="tooltip"]').tooltip();
//
//			// Get ACTIVE Alarms
//			setTimeout(dbxTuneCheckActiveAlarms, 100);
//		},
//		error: function(xhr, desc, err) 
//		{
//			console.log(xhr);
//			console.log("Details: " + desc + "\nError: " + err);
//		}
//	}); // end: ajax call

	var global_layoutNeedNewLine = 0;
	function readServerLayoutEntry(entry) 
	{
//		console.log("---------- global_layoutNeedNewLine = '"+global_layoutNeedNewLine);
//		console.log('readServerLayoutEntry(): entry: ' + entry);

		var html = "";

		if (entry.type === "group")
		{
			console.log("INFO: GROUP entry: text='" + entry.text + "'", entry);

			if (global_layoutNeedNewLine)
			{
				html += "<br>";
				global_layoutNeedNewLine = 0;
			}

			if (entry.hasOwnProperty('options') && entry.options.hasOwnProperty('border') && entry.options.border === "true")
			{
				html += "<div class='card border-dark'>";
				html += "  <div class='card-header' style='padding: .25rem .75rem; background-color: #e2e2e2;'><b>" + entry.text + "</b></div>";
				html += "  <div class='card-body' style='padding: .75rem .75rem .25rem .75rem; background-color: #e9ecef;'>";

				// CONTENT GOES HERE
				if (entry.hasOwnProperty('entries'))
				{
					// read: entries
					// read: entries
					for (var i=0; i<entry.entries.length; i++) 
					{
						var localEntry = entry.entries[i];
						html += readServerLayoutEntry(localEntry);
					}
				}
				
				html += "  </div>";
				html += "</div>";
			}
			else
			{
//				html += "<hr>";
//				html += "---group--- " + entry.text + "<br>";

				// Add Some chars at the start (that is if the string doesnt start with any "special chars"...
				var prefix = "";
//				var regEx = new RegExp("[a-zA-Z]");
//				if ( regEx.test(entry.text.charAt(0)) )
//					prefix = "&#8213;&#10148; ";

				html += prefix + "<b>" + entry.text + "</b><br>";
				

				// CONTENT GOES HERE
				if (entry.hasOwnProperty('entries'))
				{
					// read: entries
					for (var i=0; i<entry.entries.length; i++) 
					{
						var localEntry = entry.entries[i];
						html += readServerLayoutEntry(localEntry);
					}
				}
			}
		}
		else if (entry.type === "label")
		{
			console.log("INFO: LABEL entry: text='" + entry.text + "'", entry);

			if (global_layoutNeedNewLine)
			{
				html += "<br>";
				global_layoutNeedNewLine = 0;
			}

			// if entry is empty, we just need a newline (which we will get by 'global_layoutNeedNewLine')
			if (entry.text !== "")
				html += entry.text + "<br>";
		}
		else if (entry.type === "server")
		{
			console.log("INFO: SERVER entry: text='" + entry.text + "'", entry);

			if (entry.hasOwnProperty('srvSession'))
			{
				var srvSession = entry.srvSession;
				
				if ((parseInt(srvSession.status) & 1) === 1) // 1=DISABLED
				{
					console.log("Skipping server '"+srvSession.serverName+"', since it's in DISABLED Status (status=1)");
					return html;
				}

				// Uggly: increment global var
				global_layoutNeedNewLine = 1;

				var lastSampleTimeDuration = moment.duration(moment().diff(srvSession.lastSampleTime));
				var lastSampleWarnThresh   = 5; // # minutes
			
				var tt =
				  "<table class='table table-sm'>"+
				  "  <tr> <th nowrap colspan='2'>"+srvSession.serverDescription+"</th> </tr>"+
				  "  <tr> <td nowrap>DBMS Server Name  </td> <td nowrap>"+ srvSession.serverName              +"</td> </tr>"+
				  "  <tr> <td nowrap>DBMS On Hostname  </td> <td nowrap>"+ srvSession.onHostname              +"</td> </tr>"+
				  "  <tr> <td nowrap>Collector         </td> <td nowrap>"+ srvSession.productString           +"</td> </tr>"+
				  "  <tr> <td nowrap>Collector Hostname</td> <td nowrap>"+ srvSession.collectorHostname       +"</td> </tr>"+
				  "  <tr> <td nowrap>Collector Interval</td> <td nowrap>"+ srvSession.collectorSampleInterval +"</td> </tr>"+
				  "  <tr> <td nowrap>Last Sample       </td> <td nowrap>"+ moment(srvSession.lastSampleTime).format("YYYY-MM-DD HH:mm:ss") + (lastSampleTimeDuration.asMinutes() < lastSampleWarnThresh ? "" : ", <font color='red'>"+lastSampleTimeDuration.format()+"</font> since last sample" ) + "</td> </tr>"+
				  "</table>";
				  // The above tooltip didn't render that well (the table was wider than the "popup", which made it unreadable)
				  // overide: .tooltip-inner { max-width: 1000px; } in the CSS and it worked better
				  // tt = srvSession.serverDescription;
			
				// set button class depending on how long ago since we got any sample for this server
				var btnClass="btn-primary";
				if (lastSampleTimeDuration.asMinutes() >= lastSampleWarnThresh)
					btnClass="btn-warning";
			
				var dbxButtonImage="dbx-button-image dbx-button-"+srvSession.productString.toLowerCase();
			
				// Below is a LINK Button, so you can both do right click on the link to open, and click to open (using the properties: open-in-{here|tab}, time, subscribe)
				const startTime = $('#dbx-hours-txt').val() + "h";
			
				html += ''
						+ '<div class="btn-group">'
						+ '  <button id="btn-qa-normal-'+srvSession.serverName+'" type="button" class="btn btn-sm '+btnClass+' '+dbxButtonImage+' mb-2 mr-2 dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">'
						+ '    '+srvSession.serverName
						+ '    <span id="btn-qa-normal-alarms-'+srvSession.serverName+'", class="badge badge-pill badge-warning"></span>'
						+ '  </button>'
						+ '  <div class="dropdown-menu">'
						+ '    <a class="dropdown-item" href="/graph.html?subscribe=true&startTime='+startTime+'&sessionName='+srvSession.serverName+'"               onclick=\'return openGraphPage("server-ssp", "'+srvSession.serverName+'", "")\'>Show <b>System Selected</b> Graphs</a>'
						+ '    <a class="dropdown-item" href="/graph.html?subscribe=true&startTime='+startTime+'&sessionName='+srvSession.serverName+'&graphList=all" onclick=\'return openGraphPage("server-all", "'+srvSession.serverName+'", "")\'>Show <b>ALL</b> Available Graphs</a>'
						+ '    <div class="dropdown-divider"></div>'
						+ '    <a class="dropdown-item" href="/report?op=viewLatest&name='+srvSession.serverName+'" target="_blank">Open <b>Latest</b> Daily Summary Report</a>'
						+ '    <a class="dropdown-item" href="/overview#dsr-srv-'+srvSession.serverName+'" target="_blank">View <b>List</b> of <b>all</b> Daily Summary Report for this Server</a>'
						+ '    <a class="dropdown-item" href="/overview?op=dsr-current-srv&srv='+srvSession.serverName+'" target="_blank"><b>Create</b> Daily Summary Report on Current Recording</a>'
						+ '    <div class="dropdown-divider"></div>'
						+ '    <a class="dropdown-item" href="/overview#offline-srv-'+srvSession.serverName+'" target="_blank">View <b>List</b> of all <b>Recordings</b> for this Server</a>'
						+ '    <div class="dropdown-divider"></div>'
						+ '    <a class="dropdown-item" href="/log?name='+srvSession.serverName+'.console&tail=5000" target="_blank"><b>Tail</b> Collector Console File</a>'
						+ '    <div class="dropdown-divider"></div>'
						+ '    <a class="dropdown-item" data-toggle="tooltip" data-placement="bottom" data-html="true" title="'+tt+'" href="#">Server <b>Info</b></a>'
						+ '  </div>'
						+ '</div>';
			}
		}

		return html;
	}

	//-----------------------------------------------------------
	// get SERVERS
	//-----------------------------------------------------------
	$.ajax(
	{
		url: "/api/server-layout",
		type: 'get',
		// async: false,   // to call it one by one (async: true = spawn away a bunch of them in the background)
		
		success: function(data, status) 
		{
			// console.log("RECEIVED DATA: "+data);
			var jsonResp = JSON.parse(data);
			
			var html = "";
			for (var i=0; i<jsonResp.length; i++) 
			{
				var entry = jsonResp[i];

				if (entry.hasOwnProperty('type'))
				{
					html += readServerLayoutEntry(entry);
				}
			}

			// If nothing was found... add "dummy" button
			if (html === "")
			{
				html = '<button type="button" class="btn btn-sm btn-primary mb-2 mr-2">NO-SERVERS-HAS-YET-BEEN-ADDED</button>';
			}
			
			// Set HTML in DOM
			$('#dbx-quick-access-server-list').html(html);

			// Enable bootstrap tooltip...
			$('[data-toggle="tooltip"]').tooltip();

			// Get ACTIVE Alarms
			setTimeout(dbxTuneCheckActiveAlarms, 100);
		},
		error: function(xhr, desc, err) 
		{
			console.log(xhr);
			console.log("Details: " + desc + "\nError: " + err);
		}
	}); // end: ajax call

	/** Open any graphs */
	function openGraphPage(type, name, urlOptions)
	{
		if (urlOptions === null)
			urlOptions = "";
		if (urlOptions && !urlOptions.startsWith("&")) 
			urlOptions = "&" + urlOptions;

		console.log("openGraphPage(type='"+type+"', name='"+name+"', urlOptions='"+urlOptions+"')");

		const startTime       = $('#dbx-hours-txt')       .val() + "h";
		const subscribe       = $('#dbx-subscribe-chk')   .is(":checked");
		const openInNewTab    = $('#dbx-openInNewTab-chk').is(":checked");
		const colorSchemaDark = $('#dbx-graphCsDark-chk') .is(":checked");
		const gColsTxt        = $('#dbx-gcols-txt')       .val();
		
		var colorSchema = "";
		if (colorSchemaDark)
			colorSchema = "&cs=dark";
			
		// Number.isInteger(gColsTxt) --- did NOT work... so falling back to jQuery
		var gcols = "";
		if ( (gColsTxt != "") && $.isNumeric(gColsTxt) )
			gcols = "&gcols="+gColsTxt;

		// Construct the URL to use
		if (type === "server-ssp")
		{
			url = "/graph.html?subscribe="+subscribe+colorSchema+gcols+"&startTime="+startTime+"&sessionName="+name+urlOptions;
		}
		else if (type === "server-all")
		{
			url = "/graph.html?subscribe="+subscribe+colorSchema+gcols+"&startTime="+startTime+"&sessionName="+name+"&graphList=all"+urlOptions;
		}
		else if (type === "profile")
		{
			url = "/graph.html?subscribe="+subscribe+colorSchema+gcols+"&startTime="+startTime+"&sessionName="+name+urlOptions;
		}
		else
		{
			console.log("ERROR: unknown type='"+type+"'. Can't continue.");
		}

		// Open the URL
		if (openInNewTab)
		{
			window.open(url, '_blank');
		}
		else
		{
			location.href = url;
		}
		return false;
	}
	
	//-----------------------------------------------------------
	// get PROFILES
	//-----------------------------------------------------------
	console.log("get profiles: /api/graph/profiles");
	$.ajax(
	{
		url: "/api/graph/profiles",  // status=0 (ONLY ENABLED)
		type: 'get',
		// async: false,   // to call it one by one (async: true = spawn away a bunch of them in the background)
		
		success: function(data, status) 
		{
			console.log("RECEIVED DATA: "+data);
			var jsonResp = JSON.parse(data);
			console.log("profiles: jsonResp", jsonResp);
			
			var htmlCurrent = $('#dbx-quick-access-profile-list').html();
			var html = "";
			for (var i=0; i<jsonResp.length; i++) 
			{
				var entry = jsonResp[i];

				console.log("profiles: entry", entry);

				if (entry.profileName === "")
					continue;

				var urlOptions = entry.profileUrlOptions;
				if (urlOptions === null)
					urlOptions = "";
				if (urlOptions && !urlOptions.startsWith("&")) 
					urlOptions = "&" + urlOptions;

				const startTime = $('#dbx-hours-txt').val() + "h";

			//	html += '<a class="btn btn-sm btn-primary mb-2 mr-2" data-toggle="tooltip" data-placement="bottom" data-html="true" title="'+entry.profileDescription+'" href="/graph.html?subscribe=true&startTime=2h&sessionName='+entry.profileName+urlOptions+'" role="button">'+entry.profileName+'</a>';
			//	html += '<span data-toggle="tooltip" data-placement="top"    data-html="true" title="'+entry.profileDescription+'"><button type="button" class="btn btn-sm btn-primary mb-2 mr-2" onclick=\'return openGraphPage("profile", "'+entry.profileName+'", "'+entry.profileUrlOptions+'")\'>'+entry.profileName+'</button></span>';

				// Below is a LINK Button, so you can both do right click on the link to open, and click to open (using the properties: open-in-{here|tab}, time, subscribe)
				html += '<a class="btn btn-sm btn-primary mb-2 mr-2" data-toggle="tooltip" data-placement="bottom" data-html="true" title="'+entry.profileDescription+'" href="/graph.html?subscribe=true&startTime='+startTime+'&sessionName='+entry.profileName+urlOptions+'" role="button" onclick=\'return openGraphPage("profile", "'+entry.profileName+'", "'+entry.profileUrlOptions+'")\'>'+entry.profileName+'</a>';
			}
			$('#dbx-quick-access-profile-list').html(html + htmlCurrent);
		},
		error: function(xhr, desc, err) 
		{
			console.log(xhr);
			console.log("Details: " + desc + "\nError: " + err);
		}
	}); // end: ajax call

	//-----------------------------------------------------------
	// get ALARMS
	//-----------------------------------------------------------
	function dbxTuneCheckActiveAlarms() 
	{
		console.log("get active-alarms: /api/alarm/active");
		$.ajax(
		{
			url: "api/alarm/active",
			type: 'get',
			//async: false,   // to call it one by one (async: true = spawn away a bunch of them in the background)
        
			success: function(data, status) 
			{
				// console.log("RECEIVED DATA: "+data);
				var jsonResp = JSON.parse(data);

				// update ACTIVE Alarm view (note: there can be several servers)
				var activeAlarmsTopDiv = document.getElementById("active-alarms-top");
				var activeAlarmsDiv    = document.getElementById("active-alarms");
				var activeAlarmsWinDiv = document.getElementById("active-alarms-win");

				var alarmSrvCount = 0;
				var alarmSumCount = 0;

				// remove Alarm Count from all server buttons
				let btnQaNormalAlarms = document.querySelectorAll('*[id^="btn-qa-normal-alarms-"]');
				btnQaNormalAlarms.forEach( function(item) { item.textContent = ""; } ); 

				// remove 'btn-danger' from all server buttons
				let btnQaNormal = document.querySelectorAll('*[id^="btn-qa-normal-"]');
//				let btnQaAll    = document.querySelectorAll('*[id^="btn-qa-all-"]');
				btnQaNormal.forEach( function(item) { item.classList.remove('btn-danger'); } );
//				btnQaAll   .forEach( function(item) { item.classList.remove('btn-danger'); } );

				// ADD 'btn-success' from all server buttons (which would be the GOOD STATE)
				// if we have problems... set it to "danger" if we see errors
				btnQaNormal.forEach( function(item) { item.classList.add('btn-success'); } );
//				btnQaAll   .forEach( function(item) { item.classList.add('btn-success'); } );

				// remove all old alarms (new/active will be inserted again)
				let activeAlarmDivs = document.querySelectorAll('*[id^="active-alarms-srv-"]');
				activeAlarmDivs.forEach( function(item) { item.remove(); } );

				// reorder: stuff a outer "map", which is the server, and all it's alarms
				var srvAlarmMap = {}; // new object (this will be the Map with <String>, Array<AlarmEntry>)
				for (var i=0; i<jsonResp.length; i++) 
				{
					var srvName = jsonResp[i].srvName;

					// Check if KEY exists, if NOT create an array, where we will "stuff" AlarmEntries
					if ( ! srvAlarmMap.hasOwnProperty(srvName) )
						srvAlarmMap[srvName] = [];

					srvAlarmMap[srvName].push(jsonResp[i]);
				}
				if (_debug > 1)
					console.log("dbxTuneCheckActiveAlarms(): srvAlarmMap:",srvAlarmMap);

				// Loop the alarm MAP
				for (var key in srvAlarmMap) 
				{
					var entry = srvAlarmMap[key];
					// var graphServerName = entry.srvName;
					var graphServerName = key;

//console.log("dbxTuneCheckActiveAlarms(): graphServerName="+graphServerName+", entry:", entry);

					alarmSrvCount++;
					var numOfAlarmsForThisServer = entry.length;

					// Set the button to RED if we got an alarm on that server
					if (document.getElementById("btn-qa-normal-"+graphServerName) != null)
					{
						document.getElementById("btn-qa-normal-alarms-"+graphServerName).textContent = numOfAlarmsForThisServer;

						document.getElementById("btn-qa-normal-"+graphServerName).classList.remove('btn-success');
//						document.getElementById("btn-qa-all-"   +graphServerName).classList.remove('btn-success');

						document.getElementById("btn-qa-normal-"+graphServerName).classList.add('btn-danger');
//						document.getElementById("btn-qa-all-"   +graphServerName).classList.add('btn-danger');
					}

					// if (_serverList.indexOf(graphServerName) == -1)
					// {
					// 	if (_debug > 1)
					// 		console.log("dbxTuneCheckActiveAlarms(): SKIPPING... NOT in the server list. graphServerName="+graphServerName+", serverlist:", _serverList);
					// 	continue;
					// }
					if (_debug > 1)
						console.log("dbxTuneCheckActiveAlarms(): graphServerName="+graphServerName+", entry:", entry);

					// If any Active alarms create a new SRV-DIV and a table...
					if (typeof graphServerName !== 'undefined')
					{
						let srvDiv = document.getElementById("active-alarms-srv-"+graphServerName);
						if (srvDiv === null)
						{
							srvDiv = document.createElement("div");
							srvDiv.id = "active-alarms-srv-"+graphServerName;

							activeAlarmsWinDiv.appendChild(srvDiv);
						}
						let stripHtmlInCells = document.getElementById("active-alarms-compExtDesc-chk").checked;
						let tab = jsonToTable(entry, stripHtmlInCells);
						srvDiv.innerHTML = "Active Alarms for server: <b>"+graphServerName+"</b>";
						srvDiv.appendChild(tab);
						srvDiv.appendChild(document.createElement("br"));

						alarmSumCount += entry.length;

						if (_debug > 1)
							console.log("TABLE for srv'"+graphServerName+"': ", tab);
					}
					else // Remove the SRV-DIV if no active alarm
					{
						let srvDiv = document.getElementById("active-alarms-srv-"+graphServerName);
						if (srvDiv !== null)
							activeAlarmsWinDiv.removeChild(srvDiv);
					}
				}

				// should we show the activeAlarmsDiv or not?
				if (_debug > 0)
					console.log("activeAlarmsDiv.getElementsByTagName('*').length: "+activeAlarmsDiv.getElementsByTagName('*').length);
				if (activeAlarmsWinDiv.getElementsByTagName('*').length > 0)
				{
					activeAlarmsTopDiv.style.visibility = 'visible';
					activeAlarmsDiv.style.visibility = 'visible';
					pageTitleNotification.on("---ALARM---", 1000);
				}
				else
				{
					activeAlarmsTopDiv.style.visibility = 'hidden';
					activeAlarmsDiv.style.visibility = 'hidden';
					pageTitleNotification.off();
				}
        
				// Set how many ACTIVE ALarms we have...
				document.getElementById('dbx-alarm-cnt').innerHTML       = alarmSumCount;
				document.getElementById('active-alarms-count').innerHTML = alarmSumCount;

				// Set how many servers
				if (alarmSrvCount === 0)
					document.getElementById('dbx-alarm-srv-cnt').innerHTML = ".";
				else
					document.getElementById('dbx-alarm-srv-cnt').innerHTML = ", in " + alarmSrvCount + " Server(s).";
			},
			error: function(xhr, desc, err) 
			{
				console.log(xhr);
				console.log("Details: " + desc + "\nError: " + err);
			}
		}); // end: ajax call
	} // end: function

	//-----------------------------------------------------------
	// update "### seconds ago"
	//-----------------------------------------------------------
	function updateLastUpdatedClock() 
	{
		var ageInSec = Math.floor((new Date() - lastUpdateTime) / 1000);
		document.getElementById('dbx-alarm-age').innerHTML = ageInSec;

		// do we need to refresh???
		if (_refresh > 0 && ageInSec >= _refresh)
		{
			location.reload(true); // Reload the whole window
			//dbxTuneCheckActiveAlarms();
			lastUpdateTime = new Date();
		}

		setTimeout(updateLastUpdatedClock, 1000); 
	}
	var lastUpdateTime = new Date();
	updateLastUpdatedClock();

	//-----------------------------------------------------------
	// If this is a login request... open the dialog
	//-----------------------------------------------------------
//	var user = getCurrentLogin();
//	if (isParameter('login') && user === "")
//	{
//		console.log("DO_LOGIN: is true, open modal login dialog.");
//		setTimeout(function() { $('#dbx-login-dialog').modal('show'); }, 10);
//	}
	isLoggedIn( function(isLoggedIn, asUserName) 
	{
		console.log("isLoggedIn-callback: isLoggedIn='"+isLoggedIn+"', asUserName='"+asUserName+"'.");
		if (isParameter('login') && !isLoggedIn)
		{
			console.log("isLoggedIn-callback: is true, open modal login dialog.");

			var loginFailed = getParameter("login", "open");
			if (loginFailed === "failed")
				$('#dbx-loginFailed-div').css("display", "block");

			$('#dbx-login-dialog').modal({backdrop: 'static', keyboard: false});
			$('#dbx-login-dialog').modal('show');
		}
	});

</script>
</body>
</html>
