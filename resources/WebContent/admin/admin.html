<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<title>DbxTune - Central</title>

  <!--
    =======================================================================
    == JS imports - JAVA SCRIPTS GOES HERE
    =======================================================================
  -->
  <!-- JS: JQuery -->
  <script type="text/javascript" src="/scripts/jquery/jquery-3.7.0.min.js"></script>
  <script type="text/javascript" src="/scripts/jquery/ui/1.13.2/jquery-ui.min.js"></script>

  <!-- JS: Moment; used by: ChartJs, DateRangePicker -->
  <script type="text/javascript" src="/scripts/moment/moment.js"></script>
  <script type="text/javascript" src="/scripts/moment/moment-duration-format.js"></script>

  <!-- JS: Bootstrap -->
  <script type="text/javascript" src="/scripts/popper/1.12.9/popper.min.js"></script>
  <script type="text/javascript" src="/scripts/bootstrap/js/bootstrap.min.js"></script>

  <!-- JS: Selectize -->
  <script type="text/javascript" src="/scripts/selectize/js/standalone/selectize.js"></script>

  <!-- JS: DbxCentral -->
  <script type="text/javascript" src="/scripts/dbxcentral.utils.js"></script>

  <!--
    =======================================================================
    == CSS imports - STYLES SHEETS GOES HERE
    =======================================================================
  -->
  <!-- CSS: jqueri-ui -->
  <link rel="stylesheet" href="/scripts/jquery/ui/1.13.2/themes/smoothness/jquery-ui.css">

  <!-- CSS: DbxCentral -->
  <link rel="stylesheet" href="/scripts/css/dbxcentral.css">

  <!-- CSS: Bootstrap -->
  <link rel="stylesheet" href="/scripts/bootstrap/css/bootstrap.min.css">

  <!-- CSS: Font Awsome -->
  <link rel="stylesheet" href="/scripts/font-awesome/4.4.0/css/font-awesome.min.css">

  <!-- CSS: Selectize -->
  <!-- <link rel="stylesheet" href="/scripts/selectize/css/selectize.css"> -->
  <!-- <link rel="stylesheet" href="/scripts/selectize/css/selectize.default.css"> -->
  <!-- <link rel="stylesheet" href="/scripts/selectize/css/selectize.bootstrap3.css"> -->
  <link rel="stylesheet" href="/scripts/selectize/css/selectize.default.css">

  <!-- Local CSS -->
  <style type='text/css'>
    /* table {border-collapse: collapse;}
    th, td {border: 1px solid black; text-align: left; padding: 2px;}
    tr:nth-child(even) {background-color: #f2f2f2;} */
    .dbx-quick-access-tooltip-table table {border-collapse: collapse;}
    .dbx-quick-access-tooltip-table th, td {border: 1px solid white; text-align: left; padding: 2px;}

    .tooltip-inner { max-width: 1000px; }

    .jumbotron{ margin-top:-30px; }

	/* selectize selected items */
	.ui-sortable-handle {
		width: 100%;
	}
	.selectize-dropdown, .selectize-dropdown.form-control{
		height: 35vh !important;
	}
	.selectize-dropdown-content{
		max-height: 100% !important;
		height: 100% !important;
	}

	/* extra small button */
	.btn-group-xs > .btn, .btn-xs {
		padding: .4rem .4rem;
		font-size: .875rem;
		line-height: .5;
		border-radius: .2rem;
	}
  </style>

</head>

<body>
  <!-- NavBar that works, except for: iphone... -->
  <nav class="navbar navbar-expand-md navbar-dark sticky-top bg-dark mb-0">
    <a class="navbar-brand" href="/">DbxCentral</a>
    <!-- <a class="navbar-brand" href="#"><img style="	width: 32px;" src="images/dbxcentral_32.png">DbxCentral</a> -->
    <!-- <a class="navbar-brand" href="#"><img style="	width: 16px;" src="images/dbxcentral_16.png">DbxCentral</a> -->
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarCollapse">
      <ul class="navbar-nav mr-auto">
        <li class="nav-item">
          <a class="nav-link" href="/overview">Servers</a>
        </li>
        <li class="nav-item active">
          <a class="nav-link" href="/admin/admin.html">Admin</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/desktop_app.html">Desktop App</a>
        </li>
      </ul>
	  <!-- on the right hand side of the menu... -->
      <ul class="navbar-nav">
	    <!-- IS LOGGED IN -->
        <div id="dbx-nb-isLoggedIn-div" style="display: none;">
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              <i class="fa fa-user"></i> <span id="dbx-nb-isLoggedInUser-div"></span> <!-- current username will be in here -->
            </a>
            <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdownMenuLink">
            <a class="dropdown-item" href="#"> <i class="fa fa-cog"></i> Settings [not-yet-implemented]</a>
            <a class="dropdown-item" href="/logout"> <i class="fa fa-sign-out"></i> Logout</a>
            </div>
          </li>
        </div>
	    <!-- IS LOGGED OUT -->
        <div id="dbx-nb-isLoggedOut-div">
          <a class="nav-link" href="/index.html?login=open"> <i class="fa fa-sign-in"></i> <span data-toggle="tooltip" title="Log in as a specific user.">Login</span></a>
        </div>
      </ul> <!-- end right hand side -->
    </div>
  </nav>

  <!-- Basic info + "QUICK ACCESS" buttons to server graphs... -->
  <main role="main" class="container">
    <div class="jumbotron">
      <h1>DbxTune - Administration</h1>
<!--
      <p class="lead">Administration of ...</p>
      <p></p>
-->
      <!-- - - - - - - - - - - - - - - - - - - - - - - - - - - -->
      <!-- DBMS Server Admin -->
      <!-- - - - - - - - - - - - - - - - - - - - - - - - - - - -->
      <div id='server-admin' class='card border-dark mb-3'>
        <h5 class='card-header'>DBMS Server Administration</h5>
        <div class='card-body'>

          <b>Add</b> a new DBMS server... (not yet implemented)
          <div id="dbx-add-server-div">
            <a class="btn btn-sm btn-primary mb-2" data-toggle="tooltip" data-placement="right" title="Open a dialog where you can add 'Servers' to the configuration." href="/admin?op=addServer&name=DUMMY_ASE" role="button">Add...</a>
          </div>

          <b>Remove</b> Any off the below servers... (a confirm dialog will be displayed)
          <div id="dbx-remove-server-list">
              <button type="button" class="btn btn-sm btn-primary">Loading server list <i class='fa fa-spinner fa-spin '></i></button>
          </div>

          <b>Disable</b> Any off the below servers... (it will not show up in the server list)
          <div id="dbx-disable-server-list">
              <button type="button" class="btn btn-sm btn-primary">Loading server list <i class='fa fa-spinner fa-spin '></i></button>
          </div>

          <b>Enable</b> Any off the below servers... (below list has been disabled)
          <div id="dbx-enable-server-list">
              <button type="button" class="btn btn-sm btn-primary">Loading server list <i class='fa fa-spinner fa-spin '></i></button>
          </div>

          <div id="delete-result"></div>

        </div>  <!-- end: card-body -->
      </div>  <!-- end: card -->

      <!-- - - - - - - - - - - - - - - - - - - - - - - - - - - -->
      <!-- Graph Profiles -->
      <!-- - - - - - - - - - - - - - - - - - - - - - - - - - - -->
      <div id='graph-profiles' class='card border-dark mb-3'>
        <h5 class='card-header'>Graph Profiles - What Graphs should be visible</h5>
        <div class='card-body'>
          <b>Change</b> any of System Profiles
          <div id="dbx-change-ssp-div">
            <div id="dbx-change-ssp-product-list">
              <button type="button" class="btn btn-sm btn-primary">Loading DbxProduct list <i class='fa fa-spinner fa-spin '></i></button>
            </div>
            <!--<a class="btn btn-sm btn-primary mb-2" data-toggle="tooltip" data-placement="right" title="Open a dialog where you can add/change Chart profiles." href="/admin?op=addServer&name=DUMMY_ASE" role="button">Add/Change Profile...</a>-->
    <!--
    		<div class="sandbox">
    			<label for="input-draggable">XXXXXXXXXXXX:</label>
    			<input type="text" id="input-draggable" class="demo-default" placeholder="Type to Search...">
    		</div>
    -->
          </div>

          <b>Change</b> any User Defined Profiles
          <div id="dbx-change-udp-div">
            <div id="dbx-change-udp-list">
              <button type="button" class="btn btn-sm btn-primary">Loading User Defined Profile list <i class='fa fa-spinner fa-spin '></i></button>
            </div>
          </div>

          <b>Remove</b> any User Defined Profiles (<b>Warning: NO Confirm dialog!</b>)
          <div id="dbx-remove-udp-div">
            <div id="dbx-remove-udp-list">
              <button type="button" class="btn btn-sm btn-primary">Loading User Defined Profile list <i class='fa fa-spinner fa-spin '></i></button>
            </div>
          </div>

          <b>Add</b> any User Defined Profiles
          <div id="dbx-addUdg-div">
            <a class="btn btn-sm btn-primary" data-toggle="tooltip" data-placement="right" title="Open the main page." href="/" role="button">This is done from the "main" page...</a>
          </div>
        </div>  <!-- end: card-body -->
      </div>  <!-- end: card -->

      <!-- - - - - - - - - - - - - - - - - - - - - - - - - - - -->
      <!-- Counter Collector - REFRESH -->
      <!-- - - - - - - - - - - - - - - - - - - - - - - - - - - -->
      <div id='dbx-cc-refresh' class='card border-dark mb-3'>
        <h5 class='card-header'>Counter Collector - Refresh (send a message the collector to go to work and refresh counters)</h5>
        <div class='card-body'>

          <b>Refresh</b> any of the below Counter Collectors
          <div id="dbx-cc-refresh-server-list">
              <button type="button" class="btn btn-sm btn-primary">Loading server list <i class='fa fa-spinner fa-spin '></i></button>
          </div>

        </div>  <!-- end: card-body -->
      </div>  <!-- end: card -->

      <!-- - - - - - - - - - - - - - - - - - - - - - - - - - - -->
      <!-- Counter Collector - RESTART -->
      <!-- - - - - - - - - - - - - - - - - - - - - - - - - - - -->
      <div id='dbx-cc-restart' class='card border-dark mb-3'>
        <h5 class='card-header'>Counter Collector - Restart (send a message the collector to restart)</h5>
        <div class='card-body'>

          <b>Restart</b> any of the below Counter Collectors
          <div id="dbx-cc-restart-server-list">
              <button type="button" class="btn btn-sm btn-primary">Loading server list <i class='fa fa-spinner fa-spin '></i></button>
          </div>

        </div>  <!-- end: card-body -->
      </div>  <!-- end: card -->

      <!-- - - - - - - - - - - - - - - - - - - - - - - - - - - -->
      <!-- DBMS Alarm Admin -->
      <!-- - - - - - - - - - - - - - - - - - - - - - - - - - - -->
      <div id='alarm-admin' class='card border-dark mb-3'>
        <h5 class='card-header'>Alarm Administration (at DbxCentral)</h5>
        <div class='card-body'>

          <b>Clear</b> Active alarm(s) in DbxCentral for any off the below servers...
          <div id="dbx-alarm-clear-server-list">
              <button type="button" class="btn btn-sm btn-primary">Loading server list <i class='fa fa-spinner fa-spin '></i></button>
          </div>

        </div>  <!-- end: card-body -->
      </div>  <!-- end: card -->

      <!-- - - - - - - - - - - - - - - - - - - - - - - - - - - -->
      <!-- DBX Central Admin -->
      <!-- - - - - - - - - - - - - - - - - - - - - - - - - - - -->
      <div id='dbxc-admin' class='card border-dark mb-3'>
        <h5 class='card-header'>DbxCentral Administration</h5>
        <div class='card-body'>
          <b>Restart</b> DbxCentral
          <div id="dbx-restart-server-div">
            <!-- <a class="btn btn-sm btn-primary mb-2" onclick="restartServer()" role="button">Restart</a> -->
            <button type="button" class="btn btn-sm btn-primary" data-toggle="tooltip" data-placement="bottom" title="Restart the DbxCentral server instance. no collectors will be restarted." onclick="restartServer('normal')">Restart</button>
            <button type="button" class="btn btn-sm btn-primary" data-toggle="tooltip" data-placement="bottom" title="Restart the DbxCentral server instance, and do database 'compact'. no collectors will be restarted." onclick="restartServer('compact')">Restart (with compact)</button>
            <button type="button" class="btn btn-sm btn-primary" data-toggle="tooltip" data-placement="bottom" title="Restart the DbxCentral server instance, and do database 'defrag'. no collectors will be restarted." onclick="restartServer('defrag')">Restart (with defrag)</button>
            <!-- <span id="dbx-server-restart-spinner"><img src="/images/busy_spinner.gif" height="32" width="32"></span> -->
            <span id="dbx-server-restart-feedback"></span>
            <span id="dbx-server-restart-spinner"><img src="/images/ajax-loader.gif"></span>
          </div>

          <br>
          <b>Logout</b> as 'admin'
          <div id="dbx-logout-div">
<!--            <button class="btn btn-sm mb-2" data-toggle="tooltip" data-placement="right" title="Logout" onclick="logout()">Logout</button>-->
            <a class="btn btn-sm mb-2 btn-primary" data-toggle="tooltip" data-placement="right" title="Logout" href="/logout" role="button">Logout</a>
          </div>
        </div>  <!-- end: card-body -->
      </div>  <!-- end: card -->

      <!-- - - - - - - - - - - - - - - - - - - - - - - - - - - -->
      <!-- DBX User(s) Admin -->
      <!-- - - - - - - - - - - - - - - - - - - - - - - - - - - -->
      <div id='dbxc-user' class='card border-dark mb-3'>
        <h5 class='card-header'>User Administration</h5>
        <div class='card-body'>
          <b>Add</b> User - Done in the main window

          <br>
          <b>Change</b> User (Password or Roles) - Not yet implemented

          <br>
          <b>Remove</b> User - Not yet implemented

        </div>  <!-- end: card-body -->
      </div>  <!-- end: card -->

      <!-- - - - - - - - - - - - - - - - - - - - - - - - - - - -->
      <!-- Daily Summary Report - SKIP Entries -->
      <!-- - - - - - - - - - - - - - - - - - - - - - - - - - - -->
      <div id='dbx-dsr-skip' class='card border-dark mb-3'>
        <h5 class='card-header'>Daily Summary Report - SKIP Entries (or exclude some SQL Statements from reports)</h5>
        <div class='card-body'>

<!--        <button type="button" class="btn btn-sm btn-primary" data-toggle="tooltip" data-placement="bottom" onclick="addDsrSkipEntry()">Add Entry</button> -->
            <button type="button" class="btn btn-sm btn-primary" data-toggle="modal" data-target="#dbx-dsr-skip-dialog">Add Entry</button>
            &emsp;&emsp;&emsp; <span id='dbx-dsr-skip-count'>0</span> Entries in the below table
            <br>

            <br>
            <div id='dsr-skip-table'>
            </div>

        </div>  <!-- end: card-body -->
      </div>  <!-- end: card -->

    </div>
  </main>

  <!-- Error message: browser support -->
  <div id="browser-not-supported"></div>



  <!-- Modal: Confirm dialog -->
  <div class="modal fade" id="dbx-confirm-delete-dialog" tabindex="-1" role="dialog" aria-labelledby="dbx-confirm-delete-dialog" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="dbx-confirm-delete-dialog-title"><b>WARNING:</b> Removal of server '<b class="title"></b>' is irreversible</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          When removing the server, the following will be done.
          <ul>
<!--        <li>NOTE: you need to <b>MANUALLY STOP</b> the DbxTune Collector.</li> -->
            <li>Stopping the DbxTune collector (if possible).</li>
            <li>Remove Server from DbxCentral Meta Data tables.</li>
            <li>Remove Server Data from DbxCentral database (db schema '<b class="title"></b>').</li>
            <li>Remove all DBMS recording(s), <i>H2 database files</i></li>
            <li>Remove Server from <code>conf/SERVER_LIST</code></li>
            <li>Remove Log files for the Server</li>
            <li>Remove DSR (Daily Summary Report) files for the Server</li>
            <li>Waiting for 'Stop Server' to complete (max WaitTime is 1 minute).</li>
          </ul>
          A report will show, what was possible to remove (if you press: Remove)
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          <button type="button" class="btn btn-danger btn-ok">Remove Server</button>
        </div>
      </div>
    </div>
  </div>


  <!-- Modal Dialog: Change System Supplied Profiles for Graphs -->
  <div class="modal fade" id="dbx-change-ssp-dialog" tabindex="-1" role="dialog" aria-labelledby="dbx-change-ssp-dialog" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="dbx-change-ssp-dialog-title">Changing Graph Profile for '<b class="title"></b>'</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          Things you can do in this dialog
          <ul>
            <li><b>Add a graph</b> - Click the 'Add...' button, or select the input field, then type what you search for...</li>
            <li><b>Remove a graph</b> - Simply press the 'x' on the Graph Item</li>
            <li><b>Reorder graph display order</b> - Do <i>drag & drop</i></li>
            <li><b>Reset this profile</b> - Remove all entries and press 'Save'</li>
          </ul>
          <input type="text" id="dbx-change-ssp-input" class="demo-default" placeholder="Type to Search...">
          <span id="dbx-change-ssp-dialog-select-cnt">X</span> Graphs selected, <span id="dbx-change-ssp-dialog-available-cnt">Y</span> available Graphs
          <span><button type="button" class="btn btn-default btn-sm btn-add">Add...</button></span>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary btn-ok">Save</button>
        </div>
      </div>
    </div>
  </div>


  <!-- Modal Dialog: Change User Defined Profiles for Graphs -->
  <div class="modal fade" id="dbx-change-udp-dialog" tabindex="-1" role="dialog" aria-labelledby="dbx-change-udp-dialog" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="dbx-change-udp-dialog-title">Changing Graph Profile for '<b class="title"></b>'</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          Things you can do in this dialog
          <ul>
            <li><b>Add a graph</b> - Click the 'Add...' button, or select the input field, then type what you search for...</li>
            <li><b>Remove a graph</b> - Simply press the 'x' on the Graph Item</li>
            <li><b>Reorder graph display order</b> - Do <i>drag & drop</i></li>
            <li><b>Reset this profile</b> - Remove all entries and press 'Save'</li>
          </ul>
          <input type="text" id="dbx-change-udp-input" class="demo-default" placeholder="Type to Search...">
          <span id="dbx-change-udp-dialog-select-cnt">X</span> Graphs selected, <span id="dbx-change-udp-dialog-available-cnt">Y</span> available Graphs
          <span><button type="button" class="btn btn-default btn-sm btn-add">Add...</button></span>
		  <br>
          <div class="form-group row mt-1 mb-0">
            <label for="dbx-change-udp-desc" class="col-sm-2 col-form-label">Profile Desc</label>
            <div class="col-sm-10">
              <input type="text" class="form-control form-control-sm" id="dbx-change-udp-desc" placeholder="Describe the profile, shows up in tooltip">
            </div>
          </div>
          <div class="form-group row mb-0">
            <label for="dbx-change-udp-urlOpt" class="col-sm-2 col-form-label">URL Options</label>
            <div class="col-sm-10">
              <input type="text" class="form-control form-control-sm" id="dbx-change-udp-urlOpt" placeholder="Other properties passed to the graph.html page, example: gcols=3">
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary btn-ok">Save</button>
        </div>
      </div>
    </div>
  </div>


	<!-- Modal: DSR Daily Summary Report - SKIP Set dialog -->
	<div class='modal fade' id='dbx-dsr-skip-dialog' tabindex='-1' role='dialog' aria-labelledby='dbx-dsr-skip-dialog' aria-hidden='true'>
		<div class='modal-dialog modal-dialog-centered modal-lg' role='document'>
		<div class='modal-content'>
			<div class='modal-header'>
			<h5 class='modal-title' id='dbx-dsr-skip-dialog-title'>Add Daily Summary Report SKIP Entry</h5>
			<button type='button' class='close' data-dismiss='modal' aria-label='Close'>
				<span aria-hidden='true'>&times;</span>
			</button>
			</div>
			<div class='modal-body'>
				<form id='dbx-dsr-skip-form' class="needs-validation" novalidate>
					<div class='form-group'>
						<label for='dbx-dsr-skip-srvName'>Server Name</label>
						<input  id='dbx-dsr-skip-srvName' name='srvName' type='text' class='form-control is-invalid' placeholder='Server Name' required>
					</div>

					<div class='form-group'>
						<label for='dbx-dsr-skip-className'>Report Class Name (this is the short name of the Java Class)</label>
						<input  id='dbx-dsr-skip-className' name='className' type='text' class='form-control is-invalid' placeholder='Report Class Name, example: AseTopSlowSql' required>
					</div>

					<div class='form-group'>
						<label for='dbx-dsr-skip-entryType'>Column name that we want to <i>filter</i> out records</label>
						<input  id='dbx-dsr-skip-entryType' name='entryType' type='text' class='form-control is-invalid' placeholder='Column Name' required>
					</div>

					<div class='form-group'>
						<label for='dbx-dsr-skip-stringVal'>Value that we want to <i>filter</i> out records in above Column Name</label>
						<input  id='dbx-dsr-skip-stringVal' name='stringVal' type='text' class='form-control is-invalid' placeholder='Filter Value' required>
					</div>

					<div class='form-group'>
						<label for='dbx-dsr-skip-description'>Describe why we want to do this</label>
						<input  id='dbx-dsr-skip-description' name='description' type='text' class='form-control' placeholder='Description'>
					</div>

					<div class='form-group'>
						<label for='dbx-dsr-skip-sqlTextExample'>SQL Text Example</label>
						<textarea id='dbx-dsr-skip-sqlTextExample' name='sqlTextExample' rows='10' class='form-control' placeholder='Example of how the SQL Text might look like'></textarea>
					</div>
					<br>

					<div id='dbx-dsr-skip-error' style='display:none;' class='alert alert-danger' role='alert'></div>

					<div class='modal-footer'>
						<button type='button' class='btn btn-default' data-dismiss='modal'>Close</button>
<!--  					<button type='submit' class="btn btn-primary btn-ok">Save</button>-->
						<input id='dbx-dsr-skip-save' class="btn btn-success" value="Save" type="submit" disabled></input>
					</div>
				</form>
			</div>
		</div>
		</div>
	</div>
	<!-- END: DSR Daily Summary Report - SKIP Set dialog -->

<script>
  // Global variables
  var _graphDesc = [];

  // Hide spinner at start
  $('#dbx-server-restart-spinner').hide();

  $('#dbx-confirm-delete-dialog').on('click', '.btn-ok', function(e) {
      var modalDiv = $(e.delegateTarget);
      var serverName = $(this).data('recordId');
      console.log("#dbx-confirm-delete-dialog: serverName: "+serverName);
      modalDiv.addClass('working');
      removeServer(serverName, modalDiv);
      // $.ajax({url: '/api/record/' + id, type: 'DELETE'})
      // $.post('/api/record/' + id).then()
      // setTimeout(function() {
      //     modalDiv.modal('hide').removeClass('working');
      // }, 1000)
  });
  $('#dbx-confirm-delete-dialog').on('show.bs.modal', function(e) {
      var data = $(e.relatedTarget).data();
      console.log("#dbx-confirm-delete-dialog: data.recordId: "+data.recordId);
      $('.title', this).text(data.recordTitle);
      $('.btn-ok', this).data('recordId', data.recordId);
  });


  /**
   * ---------------------------------------------------------------------------
   * -- Selectize -- plugin -- https://github.com/selectize/selectize.js/issues/1342
   * ---------------------------------------------------------------------------
   */
	/**
	 * Plugin: "preserve_search" (selectize.js)
	 * Based on: "preserve_on_blur" of Eric M. Klingensmith
	 *
	 * Licensed under the Apache License, Version 2.0 (the "License"); you may not use this
	 * file except in compliance with the License. You may obtain a copy of the License at:
	 * http://www.apache.org/licenses/LICENSE-2.0
	 *
	 * Unless required by applicable law or agreed to in writing, software distributed under
	 * the License is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF
	 * ANY KIND, either express or implied. See the License for the specific language
	 * governing permissions and limitations under the License.
	 */
	Selectize.define('preserve_search', function (options) {
		var self = this;

		options.text = options.text || function (option) {
			return option[this.settings.labelField];
		};

		this.onBlur = (function (e) {
			var original = self.onBlur;

			return function (e) {
				// Capture the current input value
				var $input = this.$control_input;
				var inputValue = $input.val();

				// Do the default actions
				original.apply(this, [e]);

				// Set the value back                    
				this.setTextboxValue(inputValue);
			};
		})();

		this.onOptionSelect = (function (e) {
			var original = self.onOptionSelect;

			return function (e) {
				// Capture the current input value
				var $input = this.$control_input;
				var inputValue = $input.val();

				original.apply(this, [e]);
				this.setTextboxValue(inputValue);
				this.refreshOptions();
				if (this.currentResults.items.length <= 0) {
					this.setTextboxValue('');
					this.refreshOptions();
				}
			};
		})();
	});

  /**
   * ---------------------------------------------------------------------------
   * -- System Supplied Profile
   * ---------------------------------------------------------------------------
   */
	$('#dbx-change-ssp-dialog').on('click', '.btn-add', function(e) {
		var selectize = $('#dbx-change-ssp-input').selectize()[0].selectize;
		selectize.open();
	});
	$('#dbx-change-ssp-dialog').on('click', '.btn-ok', function(e) {
		var modalDiv = $(e.delegateTarget);
		var dbxProduct = $(this).data('recordId');
		console.log("#dbx-change-ssp-dialog: dbxProduct: "+dbxProduct);
		modalDiv.addClass('working');

		var selectize = $('#dbx-change-ssp-input').selectize()[0].selectize;
		var selectedItems = $.map(selectize.items, function(value) {
			return selectize.options[value];
		});
		console.log("#dbx-change-ssp-dialog: selectedItems: "+selectedItems, selectedItems);
		console.log("#dbx-change-ssp-dialog: selectize.items: "+selectize.items, selectize.items);

		// construct JSON TO Send: [ {graph:"fullGraphName1"}, {graph:"fullGraphName2"}, {graph:"fullGraphName3"}... ]
		var selectedJson = $.map(selectize.items, function(value) {
			return { graph: value };
		});
		console.log("#dbx-change-ssp-dialog: selectedJson: "+selectedJson, selectedJson);

		var sendData = {
			productString:      dbxProduct,
			userName:           '',
			profileType:        'SYSTEM_SELECTED',
			profileName:        '',
			profileDescription: '',
			profileValue:       selectedJson,
			profileUrlOptions:  ''
		};

		// send the update request
		$.ajax({
//			url: '/api/graph/profiles/' + dbxProduct,
			url: '/api/graph/profiles?dbxProduct='+dbxProduct,
			type: 'post',
			dataType: 'json',
			contentType: 'application/json',
			data: JSON.stringify(sendData),
			success: function(data, status) {
				console.log("success.status: " + status);
				console.log("success.data: " + data);

				setTimeout(function() {
					refreshGraphDescriptions();
					modalDiv.modal('hide').removeClass('working');
				}, 10);
			},
			error: function(xhr, desc, err)
			{
				console.log(xhr);
				console.log("Details: " + desc + "\nError: " + err);
			}
		});
	});
	$('#dbx-change-ssp-dialog').on('show.bs.modal', function(e) {
		var data = $(e.relatedTarget).data();
		var dbxProduct = data.recordId;

		console.log("#dbx-change-ssp-dialog: dbxProduct: "+dbxProduct);

		var ssp = _graphDesc[dbxProduct];

		// Get all 'tableName' entries from SSP System Selected Profile
		let sspEntries = ssp._SSP_.map(a => a.tableName);

		console.log("#dbx-change-ssp-dialog: preSelectedEntries: "+sspEntries, sspEntries);
//		console.log("#dbx-change-ssp-dialog: ALL.length: "+ssp._ALL_.length);

//		var selectize = $('#dbx-change-ssp-input').selectize()[0].selectize;
////		selectize.options = ssp._ALL_;
////		selectize.items   = sspEntries;
//
//		selectize.clearOptions();
//		selectize.addOption(ssp._ALL_);
////		selectize.refreshOptions();
//
//		selectize.clear();
////		selectize.addItem(sspEntries);
////		selectize.refreshItems();
//		selectize.setValue(sspEntries);


		$('#dbx-change-ssp-input').selectize()[0].selectize.destroy();
		$('#dbx-change-ssp-input').selectize({
			plugins: ['drag_drop', 'remove_button', 'preserve_search'],
			create: false, // do not allow new entries
			persist: false,
			maxItems: null,
			valueField: 'tableName',
			searchField: ['cmName', 'graphName', 'graphLabel', 'graphCategory'],
			options: ssp._ALL_,
			items:   sspEntries,
			onItemAdd: function(value, item) {
				//console.log("onItemAdd()", value, item);
				setGraphCountSelectionSsp();
			},
			onItemRemove: function(value) {
				//console.log("onItemRemove()", value);
				setGraphCountSelectionSsp();
			},
			render: {
				item: function(item, escape) {
					//console.log("render.item()", item);
					return '<div>' +
						'<span>' + escape(item.cmName) + '</span>' +
						' - <span>' + escape(item.graphName) + '</span>' +
						' - <span><i>' + escape(item.graphCategory) + '</span></i>' +
						'<br><span><b>' + escape(item.graphLabel) + '</b></span>' +
					'</div>';
				},
				option: function(item, escape) {
					//console.log("render.option()", item);
					return '<div>' +
						'<span>' + escape(item.cmName) + '</span>' +
						' - <span>' + escape(item.graphName) + '</span>' +
						' - <span><i>' + escape(item.graphCategory) + '</i></span>' +
						' - <span><b>' + escape(item.graphLabel) + '</b></span>' +
					'</div>';
				}
			}
		});
		$('#dbx-change-ssp-input').selectize()[0].selectize.setValue(sspEntries);
//		$('#dbx-change-ssp-input').selectize()[0].selectize.refreshOptions();
//		$('#dbx-change-ssp-input').selectize()[0].selectize.refreshItems();

		setGraphCountSelectionSsp();

	  $('.title', this).text(dbxProduct);
      $('.btn-ok', this).data('recordId', dbxProduct);
  });

  /**
   * set "#dbx-change-ssp-dialog-select-cnt" and "#dbx-change-ssp-dialog-available-cnt"
   */
  function setGraphCountSelectionSsp()
  {
	let selectedItems   = $('#dbx-change-ssp-input').selectize()[0].selectize.items.length;
	let availableItems  = $('#dbx-change-ssp-input').selectize()[0].selectize.order;
	let unSelectedItems = availableItems - selectedItems;

	$("#dbx-change-ssp-dialog-select-cnt")   .text( selectedItems );
	$("#dbx-change-ssp-dialog-available-cnt").text( availableItems );
//	$("#dbx-change-ssp-dialog-unselected-cnt").text( unSelectedItems );
  }





  /**
   * ---------------------------------------------------------------------------
   * -- User Defined Profile
   * ---------------------------------------------------------------------------
   */
	$('#dbx-change-udp-dialog').on('click', '.btn-add', function(e) {
		var selectize = $('#dbx-change-udp-input').selectize()[0].selectize;
		selectize.open();
	});
	// -------------- OK ---------------------
	$('#dbx-change-udp-dialog').on('click', '.btn-ok', function(e) {
		var modalDiv = $(e.delegateTarget);
		var profileName = $(this).data('recordId');
		console.log("#dbx-change-udp-dialog: profileName: "+profileName);
		modalDiv.addClass('working');

		var profileDescription = document.getElementById("dbx-change-udp-desc"  ).value;
		var profileUrlOptions  = document.getElementById("dbx-change-udp-urlOpt").value;

		var selectize = $('#dbx-change-udp-input').selectize()[0].selectize;
		var selectedItems = $.map(selectize.items, function(value) {
			return selectize.options[value];
		});
		console.log("#dbx-change-udp-dialog: selectedItems: "+selectedItems, selectedItems);
		console.log("#dbx-change-udp-dialog: selectize.items: "+selectize.items, selectize.items);

		// construct JSON TO Send: [ {graph:"fullGraphName1"}, {graph:"fullGraphName2"}, {graph:"fullGraphName3"}... ]
		var selectedJson = $.map(selectize.items, function(value) {
			var srvGraphArr = value.split("|");
			return { srv: srvGraphArr[0], graph: srvGraphArr[1] };
		});
		console.log("#dbx-change-udp-dialog: selectedJson: "+selectedJson, selectedJson);

		var sendData = {
			productString:      '',
			userName:           '',
			profileType:        'USER_SELECTED',
			profileName:        profileName,
			profileDescription: profileDescription,
			profileValue:       selectedJson,
			profileUrlOptions:  profileUrlOptions
		};

		console.log("SAVE Send JSON: ", sendData);

		// send the update request
		$.ajax({
			url: '/api/graph/profiles?dbxProduct='+profileName,   // Note: the dbxProduct is not really used...
			type: 'post',
			dataType: 'json',
			contentType: 'application/json',
			data: JSON.stringify(sendData),
			success: function(data, status) {
				console.log("success.status: " + status);
				console.log("success.data: " + data);

				setTimeout(function() {
					refreshGraphDescriptions();
					modalDiv.modal('hide').removeClass('working');
				}, 10);
			},
			error: function(xhr, desc, err)
			{
				console.log(xhr);
				console.log("Details: " + desc + "\nError: " + err);
			}
		});
	});
	// -------------- OPEN DIALOG ---------------------
	$('#dbx-change-udp-dialog').on('show.bs.modal', function(e) {
		var data = $(e.relatedTarget).data();
		var profileName = data.recordId;

		console.log("#dbx-change-udp-dialog: profileName: "+profileName);
		var graphDesc1 = [];
		var selectedGraphs = [];
		var profileDescription = '';
		var profileUrlOptions  = '';

		$.ajax(
		{
			url: "/api/graph/description",
			type: 'get',
			async: false,   // to call it one by one (async: true = spawn away a bunch of them in the background)

			success: function(data, status)
			{
				// console.log("RECEIVED DATA: "+data);
				graphDesc1 = JSON.parse(data);
				//console.log("ajax.success(): new values for graphDesc1.", graphDesc1);
			},
			error: function(xhr, desc, err)
			{
				console.log(xhr);
				console.log("Details: " + desc + "\nError: " + err);
			}
		}); // end: ajax call
		//console.log("AFTER: ajax.success(): new values for graphDesc1.", graphDesc1);

		$.ajax(
		{
//			url: "/api/graph/profiles?name="+profileName,
			url: "/api/graph/profiles",
			type: 'get',
			async: false,   // to call it one by one (async: true = spawn away a bunch of them in the background)

			success: function(data, status)
			{
				// console.log("RECEIVED DATA: "+data);
//				selectedGraphs = JSON.parse(data);
				var tmp = JSON.parse(data);
				for (var i=0; i < tmp.length; i++)
				{
					if ( tmp[i].profileName === profileName && tmp[i].profileType === 'USER_SELECTED' && tmp[i].userName === '' )
					{
						profileDescription = tmp[i].profileDescription;
						profileUrlOptions  = tmp[i].profileUrlOptions;
						selectedGraphs     = tmp[i].profileValue;
						break;
					}
				}
				//console.log("ajax.success(): new values for selectedGraphs.", selectedGraphs);
			},
			error: function(xhr, desc, err)
			{
				console.log(xhr);
				console.log("Details: " + desc + "\nError: " + err);
			}
		}); // end: ajax call
		//console.log("AFTER: ajax.success(): new values for selectedGraphs.", selectedGraphs);

		// Transform JSON from: REST object to what we want to display in the POPUP
		var graphDesc2 = [];
		Object.keys(graphDesc1).forEach(function(dbxProdKey) {
			var srvEntry = graphDesc1[dbxProdKey];
			//console.log("dbxProdKey='"+dbxProdKey+"', srvEntry='"+srvEntry+"'.");

			Object.keys(srvEntry).forEach(function(srvKey) {
				if ( ! srvKey.startsWith("_") )
				{
					var gda = srvEntry[srvKey]; // gda = GraphDescriptionArray
					//console.log("srvKey='"+srvKey+"', gda='"+gda+"'.");

					Object.keys(gda).forEach(function(i) {
						var gd = gda[i]; // gd = GraphDescription
						gd.srvName = srvKey;
						gd.srvGraph = { srv: srvKey, graph: gd.tableName };
						gd.srvGraphStr = srvKey + "|" + gd.tableName;
						//console.log("i='"+i+"'.", gd);

						graphDesc2.push(gd);
					});
				}
			});
		});
		//console.log("AFTER: transform: graphDesc2.", graphDesc2);

		// Put "pre selected" values into selectedEntries.
		// The PK: is field: srvGraphStr, which is "NameOfTheServer|NameOfTheFullGraphName"
		var selectedEntries = [];
		for (var i=0; i < selectedGraphs.length; i++)
		{
			for (var j=0; j < graphDesc2.length; j++)
			{
				if (graphDesc2[j].srvName === selectedGraphs[i].srv && graphDesc2[j].tableName === selectedGraphs[i].graph)
					selectedEntries.push( graphDesc2[j].srvGraphStr );
			}
		}
		console.log("selectedEntries: ", selectedEntries);


		$('#dbx-change-udp-input').selectize()[0].selectize.clearOptions();
		$('#dbx-change-udp-input').selectize()[0].selectize.clear(false);
		$('#dbx-change-udp-input').selectize()[0].selectize.destroy();
		$('#dbx-change-udp-input').selectize({
			plugins: ['drag_drop', 'remove_button', 'preserve_search'],
			create: false, // do not allow new entries
			persist: false,
			maxItems: null,
			valueField: 'srvGraphStr',
			searchField: ['srvName', 'dbxProduct', 'cmName', 'graphName', 'graphLabel', 'graphCategory'],
			options: graphDesc2,
			items:   selectedEntries,
			onItemAdd: function(value, item) {
				//console.log("onItemAdd()", value, item);
				setGraphCountSelectionUdp();
			},
			onItemRemove: function(value) {
				//console.log("onItemRemove()", value);
				setGraphCountSelectionUdp();
			},
			render: {
				item: function(item, escape) {
					//console.log("render.item()", item);
					return '<div>' +
						'<span>' + escape(item.srvName) + '@<i>'+escape(item.dbxProduct)+'</i></span>' +
						' - <span>' + escape(item.cmName) + '</span>' +
						' - <span>' + escape(item.graphName) + '</span>' +
						' - <span><i>' + escape(item.graphCategory) + '</span></i>' +
						'<br><span><b>' + escape(item.graphLabel) + '</b></span>' +
					'</div>';
				},
				option: function(item, escape) {
					//console.log("render.option()", item);
					return '<div class="dbx-topHr">' +
						'<span>' + escape(item.srvName) + '@<i>'+escape(item.dbxProduct)+'</i></span>' +
						' - <span>' + escape(item.cmName) + '</span>' +
						' - <span>' + escape(item.graphName) + '</span>' +
						' - <span><i>' + escape(item.graphCategory) + '</i></span>' +
						'<br><span><b>' + escape(item.graphLabel) + '</b></span>' +
					'</div>';
				}
			}
		});
//		$('#dbx-change-udp-input').selectize()[0].selectize.setValue(sspEntries);
//		$('#dbx-change-udp-input').selectize()[0].selectize.refreshOptions();
//		$('#dbx-change-udp-input').selectize()[0].selectize.refreshItems();

		setGraphCountSelectionUdp();

		document.getElementById("dbx-change-udp-desc"  ).value = profileDescription;
		document.getElementById("dbx-change-udp-urlOpt").value = profileUrlOptions;


		$('.title', this).text(profileName);
		$('.btn-ok', this).data('recordId', profileName);
	});

  /**
   * set "#dbx-change-udp-dialog-select-cnt" and "#dbx-change-udp-dialog-available-cnt"
   */
  function setGraphCountSelectionUdp()
  {
	let selectedItems   = $('#dbx-change-udp-input').selectize()[0].selectize.items.length;
	let availableItems  = $('#dbx-change-udp-input').selectize()[0].selectize.order;
	let unSelectedItems = availableItems - selectedItems;

	$("#dbx-change-udp-dialog-select-cnt")   .text( selectedItems );
	$("#dbx-change-udp-dialog-available-cnt").text( availableItems );
//	$("#dbx-change-udp-dialog-unselected-cnt").text( unSelectedItems );
  }


  /**
   * Restart server
   */
  function waitforRestartServer()
  {
    $.ajax(
    {
      //url: "/dummyfile.html",
      url: "/dummy", // a servlet is called dummy
      type: 'get',
      //async: false,   // to call it one by one (async: true = spawn away a bunch of them in the background)

      success: function(data, status)
      {
        $('#dbx-server-restart-spinner').hide();
        $('#dbx-server-restart-feedback').text('Server restarted!').fadeOut(3000);
        console.log("Content.status: " + status);
        console.log("Content: " + data);
      },
      error: function(xhr, desc, err)
      {
        console.log(xhr);
        console.log("Details: " + desc + "\nError: " + err);

        let feedbackDiv = document.getElementById('dbx-server-restart-feedback');
        feedbackDiv.innerHTML += '.';

        setTimeout(waitforRestartServer, 1000);
      }
    }); // end: ajax call
  }

  /**
   * Restart server
   */
  function restartServer(restartType)
  {
    var urlParams="&h2ShutdownType=DEFAULT";
    if (restartType === "compact")
    {
      urlParams="&h2ShutdownType=COMPACT";
    }
    else if (restartType === "defrag")
    {
      urlParams="&h2ShutdownType=DEFRAG";
    }

    $.ajax(
    {
      url: "/admin/shutdown?password=secret&restart"+urlParams,
      type: 'get',
      //async: false,   // to call it one by one (async: true = spawn away a bunch of them in the background)

      success: function(data, status)
      {
        $('#dbx-server-restart-spinner').show();
        $('#dbx-server-restart-feedback').text("Waiting for restart...").show();
        setTimeout(waitforRestartServer, 4000);
      },
      error: function(xhr, desc, err)
      {
        console.log(xhr);
        console.log("Details: " + desc + "\nError: " + err);
        $('#dbx-server-restart-feedback').text("Connect to server failed: "+err).show();
      }
    }); // end: ajax call
  }


  // function removeServerConfirmDialog(serverName)
  // {
  //   $("#dbx-confirm-delete-dialog").modal("show");
  // }

  function setServerStatus(action, serverName)
  {
    console.log("setServerStatus: action='"+action+"', serverName='"+serverName+"'.");
    // alert("setServerStatus: action='"+action+"', serverName='"+serverName+"'.");

    $.ajax(
    {
      url: "/admin?op="+action+"Server&name="+serverName,
      type: 'get',
      async: false,   // to call it one by one (async: true = spawn away a bunch of them in the background)

      success: function(data, status)
      {
        var jsonResp = JSON.parse(data);
        var actions = jsonResp.actions;
        console.log("actions: "+actions, actions);

        var tab = "<table class='table table-hover'>";
        tab += "<thead class='thead-light'><tr>";
        tab += "  <th scope='col'>Action</th>";
        tab += "  <th scope='col'>Status</th>";
        tab += "  <th scope='col'>Message</th>";
        tab += "</tr></thead>";
        tab += "<tbody>";
        for (var key in actions) {
          if (actions.hasOwnProperty(key)) {
            tab += "<tr>";
            tab += "  <td nowrap scope='row'>"+key+"</td>";
            tab += "  <td nowrap>"+actions[key].status+"</td>";
            tab += "  <td nowrap>"+actions[key].message+"</td>";
            tab += "</tr>";
          }
        }
        tab += "</tbody>";
        tab += "</table>";

        var refreshBut = '<a class="btn btn-sm btn-primary mb-2" href="/admin/admin.html" role="button">Refresh Page...</a>';
        var deleteResultDiv = document.getElementById("delete-result");
        deleteResultDiv.innerHTML = "<br><hr><p>Results when changing status for: <b>"+serverName+"</b></p>"+tab+"<br>"+refreshBut;
      },
      error: function(xhr, desc, err)
      {
        console.log(xhr);
        console.log("Details: " + desc + "\nError: " + err);

        alert("Error: action='"+action+"', serverName='"+serverName+"'. Details: " + desc + "\nError: " + err);
      }
    }); // end: ajax call

  }

  /**
   * remove Server
   */
  function removeServer(serverName, modalDiv)
  {
    console.log("Removing Server: "+serverName);
    $.ajax(
    {
      url: "/admin?op=removeServer&name="+serverName,
      type: 'get',
      //async: false,   // to call it one by one (async: true = spawn away a bunch of them in the background)

      success: function(data, status)
      {
        modalDiv.modal('hide').removeClass('working');

        var jsonResp = JSON.parse(data);
        var actions = jsonResp.actions;
        console.log("actions: "+actions, actions);

        // var tab = jsonToTable(jsonResp.actions);
        var tab = "<table class='table table-hover'>";
        tab += "<thead class='thead-light'><tr>";
        tab += "  <th scope='col'>Action</th>";
        tab += "  <th scope='col'>Status</th>";
        tab += "  <th scope='col'>Message</th>";
        tab += "</tr></thead>";
        tab += "<tbody>";
        for (var key in actions) {
          if (actions.hasOwnProperty(key)) {
            // console.log(key + " -> " + actions[key]);
            tab += "<tr>";
            tab += "  <td nowrap scope='row'>"+key+"</td>";
            tab += "  <td nowrap>"+actions[key].status+"</td>";
            tab += "  <td nowrap>"+actions[key].message+"</td>";
            tab += "</tr>";
          }
        }
        tab += "</tbody>";
        tab += "</table>";

        var refreshBut = '<a class="btn btn-sm btn-primary mb-2" href="/admin/admin.html" role="button">Refresh Page...</a>';
        var deleteResultDiv = document.getElementById("delete-result");
        deleteResultDiv.innerHTML = "<br><hr><p>Results when removing: <b>"+serverName+"</b></p>"+tab+"<br>"+refreshBut;
      },
      error: function(xhr, desc, err)
      {
        console.log(xhr);
        console.log("Details: " + desc + "\nError: " + err);
      }
    }); // end: ajax call
  }

  /**
   * clearActiveAlarms
   */
  function clearActiveAlarms(serverName)
  {
    console.log("clearActiveAlarms() serverName: "+serverName);
    $.ajax(
    {
      url: "/admin?op=clearActiveAlarms&name="+serverName,
      type: 'get',
      //async: false,   // to call it one by one (async: true = spawn away a bunch of them in the background)

      success: function(data, status)
      {
        var jsonResp = JSON.parse(data);
        var actions = jsonResp.actions;
        console.log("actions: "+actions, actions);

		alert(actions["REMOVE-ACTIVE-ALARMS"].message);
//		BootstrapDialog.show({
//			title: jsonResp.REMOVE-ACTIVE-ALARMS.status,
//            message: jsonResp.REMOVE-ACTIVE-ALARMS.message
//        });
      },
      error: function(xhr, desc, err)
      {
        console.log(xhr);
        console.log("Details: " + desc + "\nError: " + err);
      }
    }); // end: ajax call
  }


  /**
   * refreshCc
   */
  function refreshCc(serverName)
  {
    console.log("refreshCm() serverName: "+serverName);
    $.ajax(
    {
      url: "/admin?op=refreshCc&name="+serverName,
      type: 'get',
      //async: false,   // to call it one by one (async: true = spawn away a bunch of them in the background)

      success: function(data, status)
      {
        var jsonResp = JSON.parse(data);
        var actions = jsonResp.actions;
        console.log("actions: "+actions, actions);
      },
      error: function(xhr, desc, err)
      {
        console.log(xhr);
        console.log("Details: " + desc + "\nError: " + err);
      }
    }); // end: ajax call
  }


  /**
   * restartCc
   */
  function restartCc(serverName)
  {
    console.log("restartCm() serverName: "+serverName);
    $.ajax(
    {
      url: "/admin?op=restartCc&name="+serverName,
      type: 'get',
      //async: false,   // to call it one by one (async: true = spawn away a bunch of them in the background)

      success: function(data, status)
      {
        var jsonResp = JSON.parse(data);
        var actions = jsonResp.actions;
        console.log("actions: "+actions, actions);
      },
      error: function(xhr, desc, err)
      {
        console.log(xhr);
        console.log("Details: " + desc + "\nError: " + err);
      }
    }); // end: ajax call
  }


  /**
   * logout from basic authentication...
   * simply make a "dummy" call with a not existing user
   */
/*
  function logout()
  {
    console.log("logout...");
    $.ajax(
    {
      url: "/admin/admin.html",
      type: "get",
      dataType: 'json',
      async: true,
      username: "some_username_that_doesnt_exist",
      password: "any_stupid_password",
      data: '{ "dummy" }'
    })
    //In our case, we WANT to get access denied, so a success would be a failure.
    .done(function() {
      alert('Error, when trying to logout...')
    })
    //Likewise, a failure *usually* means we succeeded.
    //set window.location to redirect the user to wherever you want them to go
    .fail(function() {
      window.location = "/";
    });
  }
*/

  /**
   * refresh Graph Descriptions
   */
  function refreshGraphDescriptions()
  {
 	$.ajax(
 	{
		url: "/api/graph/description",
		type: 'get',
		// async: false,   // to call it one by one (async: true = spawn away a bunch of them in the background)

		success: function(data, status)
		{
			// console.log("RECEIVED DATA: "+data);
			var jsonResp = JSON.parse(data);

			_graphDesc = jsonResp;
			console.log("refreshGraphDescriptions(): new values for _graphDesc.", _graphDesc);
		},
		error: function(xhr, desc, err)
		{
			console.log(xhr);
			console.log("Details: " + desc + "\nError: " + err);
		}
	}); // end: ajax call
  }

  //-----------------------------------------------------------
  // get SERVERS
  //-----------------------------------------------------------
	$.ajax(
	{
    url: "/api/sessions",
		type: 'get',
		// async: false,   // to call it one by one (async: true = spawn away a bunch of them in the background)

		success: function(data, status)
		{
			// console.log("RECEIVED DATA: "+data);
			var jsonResp = JSON.parse(data);

			const dbxProducts = [...new Set(jsonResp.map(item => item.productString))];
			//console.log("DbxProducts:", dbxProducts);

			var htmlRemove  = "";
			var htmlEnable  = "";
			var htmlDisable = "";
			var htmlRefreshCc = "";
			var htmlRestartCc = "";
			var htmlClearAlarm = "";
			for (var i=0; i<jsonResp.length; i++)
			{
				var entry = jsonResp[i];

				var lastSampleTimeDuration = moment.duration(moment().diff(entry.lastSampleTime));
				var lastSampleWarnThresh   = 5; // # minutes

				var tt =
				"<table class='table table-sm'>"+
				"  <tr> <th nowrap colspan='2'>"+entry.serverDescription+"</th> </tr>"+
				"  <tr> <td nowrap>DBMS Server Name  </td> <td nowrap>"+ entry.serverName              +"</td> </tr>"+
				"  <tr> <td nowrap>DBMS On Hostname  </td> <td nowrap>"+ entry.onHostname              +"</td> </tr>"+
				"  <tr> <td nowrap>Collector         </td> <td nowrap>"+ entry.productString           +"</td> </tr>"+
				"  <tr> <td nowrap>Collector Hostname</td> <td nowrap>"+ entry.collectorHostname       +"</td> </tr>"+
				"  <tr> <td nowrap>Collector Interval</td> <td nowrap>"+ entry.collectorSampleInterval +"</td> </tr>"+
				"  <tr> <td nowrap>Last Sample       </td> <td nowrap>"+ moment(entry.lastSampleTime).format("YYYY-MM-DD HH:mm:ss") + (lastSampleTimeDuration.asMinutes() < lastSampleWarnThresh ? "" : ", <font color='red'>"+lastSampleTimeDuration.format()+"</font> since last sample" ) + "</td> </tr>"+
				"</table>";
				// The above tooltip didn't render that well (the table was wider than the "popup", which made it unreadable)
				// overide: .tooltip-inner { max-width: 1000px; } in the CSS and it worked better
				// tt = entry.serverDescription;

				// set button class depending on how long ago since we got any sample for this server
				var btnClass="btn-danger";
				// if (lastSampleTimeDuration.asMinutes() >= lastSampleWarnThresh)
				//     btnClass="btn-warning";

				var btnClass="btn-danger";
				var dbxButtonImage="dbx-button-image dbx-button-"+entry.productString.toLowerCase();

				htmlRemove  += '<span data-toggle="tooltip" data-placement="top" data-html="true" title="'+tt+'"><button type="button" class="btn btn-sm btn-danger '+dbxButtonImage+'  mb-2 mr-2" data-record-id="'+entry.serverName+'" data-record-title="'+entry.serverName+'" data-toggle="modal" data-target="#dbx-confirm-delete-dialog">'+entry.serverName+'</button></span>';
				if ((parseInt(entry.status) & 1) === 1) // 1=DISABLED
					htmlEnable  += '<span data-toggle="tooltip" data-placement="top" data-html="true" title="'+tt+'"><button type="button" class="btn btn-sm btn-primary '+dbxButtonImage+'  mb-2 mr-2" onclick=\'setServerStatus("enable",  "'+entry.serverName+'")\'>'+entry.serverName+'</button></span>';
				else
					htmlDisable += '<span data-toggle="tooltip" data-placement="top" data-html="true" title="'+tt+'"><button type="button" class="btn btn-sm btn-primary '+dbxButtonImage+'  mb-2 mr-2" onclick=\'setServerStatus("disable", "'+entry.serverName+'")\'>'+entry.serverName+'</button></span>';

				htmlRefreshCc   += '<span data-toggle="tooltip" data-placement="top" data-html="true" title="'+tt+'"><button type="button" class="btn btn-sm btn-primary '+dbxButtonImage+'  mb-2 mr-2" onclick=\'refreshCc("'+entry.serverName+'")\'>'+entry.serverName+'</button></span>';
				htmlRestartCc   += '<span data-toggle="tooltip" data-placement="top" data-html="true" title="'+tt+'"><button type="button" class="btn btn-sm btn-primary '+dbxButtonImage+'  mb-2 mr-2" onclick=\'restartCc("'+entry.serverName+'")\'>'+entry.serverName+'</button></span>';

				htmlClearAlarm  += '<span data-toggle="tooltip" data-placement="top" data-html="true" title="'+tt+'"><button type="button" class="btn btn-sm btn-primary '+dbxButtonImage+'  mb-2 mr-2" onclick=\'clearActiveAlarms("'+entry.serverName+'")\'>'+entry.serverName+'</button></span>';
			}
			if (htmlRemove  === "") htmlRemove  = '<button type="button" class="btn btn-sm btn-primary mb-2 mr-2">NO-SERVERS-HAS-YET-BEEN-ADDED</button>';
			if (htmlDisable === "") htmlDisable = '<button type="button" class="btn btn-sm btn-primary mb-2 mr-2">No Servers Found</button>';
			if (htmlEnable  === "") htmlEnable  = '<button type="button" class="btn btn-sm btn-primary mb-2 mr-2">No Servers Found</button>';

			$('#dbx-remove-server-list').html(htmlRemove);
			$('#dbx-disable-server-list').html(htmlDisable);
			$('#dbx-enable-server-list').html(htmlEnable);

			$('#dbx-refresh-server-list').html(htmlRefreshCc);
			$('#dbx-restart-server-list').html(htmlRestartCc);

			$('#dbx-alarm-clear-server-list').html(htmlClearAlarm);

			// Enable bootstrap tooltip...
			$('[data-toggle="tooltip"]').tooltip();

			// Add buttons for: 'change' System Supplied Profiles
			var htmlSsp  = "";
			for (var i=0; i<dbxProducts.length; i++)
			{
				var entry = dbxProducts[i];
				console.log("DbxProducts["+i+"]:", entry);

				var dbxButtonImage="dbx-button-image dbx-button-"+entry.toLowerCase();

//				htmlSsp += '<span><button type="button" class="btn btn-sm btn-primary '+dbxButtonImage+'  mb-2 mr-2" onclick=\'openChangeSspDialog("'+entry+'")\'>'+entry+'</button></span>';
				htmlSsp += '<span><button type="button" class="btn btn-sm btn-primary '+dbxButtonImage+'  mb-2 mr-2" data-record-id="'+entry+'" data-record-title="'+entry+'" data-toggle="modal" data-backdrop="static" data-target="#dbx-change-ssp-dialog">'+entry+'</button></span>';
			}
			if (htmlSsp === "")
				htmlSsp = '<button type="button" class="btn btn-sm btn-primary mb-2 mr-2">No DbxProduct Found</button>';
			$('#dbx-change-ssp-product-list').html(htmlSsp);
		},
		error: function(xhr, desc, err)
		{
			console.log(xhr);
			console.log("Details: " + desc + "\nError: " + err);
		}
  }); // end: ajax call

	//-----------------------------------------------------------
	// get PROFILES
	//-----------------------------------------------------------
	$.ajax(
	{
		url: "/api/graph/profiles",
		type: 'get',
		// async: false,   // to call it one by one (async: true = spawn away a bunch of them in the background)

		success: function(data, status)
		{
			// console.log("RECEIVED DATA: "+data);
			var jsonResp = JSON.parse(data);

			var html_1 = "";
			var html_2 = "";
			for (var i=0; i<jsonResp.length; i++) {
				var entry = jsonResp[i];

				if (entry.profileName === "")
					continue;
//				html_1 += '<a class="btn btn-sm btn-danger mb-2 mr-2" href="/api/FIXME?profileName='+entry.profileName+'" role="button">'+entry.profileName+'</a>';
				html_1 += '<button type="button" class="btn btn-sm btn-danger  mb-2 mr-2" onclick=\'removeUserDefinedProfile("'+entry.profileName+'")\'>'+entry.profileName+'</button>';
//				html_2 += '<button type="button" class="btn btn-sm btn-primary mb-2 mr-2" onclick=\'changeUserDefinedProfile("'+entry.profileName+'")\'>'+entry.profileName+'</button>';
				html_2 += '<span><button type="button" class="btn btn-sm btn-primary mb-2 mr-2" data-record-id="'+entry.profileName+'" data-record-title="'+entry.profileName+'" data-toggle="modal" data-backdrop="static" data-target="#dbx-change-udp-dialog">'+entry.profileName+'</button></span>';
			}
			if (html_1 === "")
				html_1 = '<button type="button" class="btn btn-sm btn-primary mb-2 mr-2">No User Defined Profiles was Found</button>';
			if (html_2 === "")
				html_2 = '<button type="button" class="btn btn-sm btn-primary mb-2 mr-2">No User Defined Profiles was Found</button>';

			$('#dbx-remove-udp-list').html(html_1);
			$('#dbx-change-udp-list').html(html_2);
		},
		error: function(xhr, desc, err)
		{
			console.log(xhr);
			console.log("Details: " + desc + "\nError: " + err);
		}
	}); // end: ajax call

	//-----------------------------------------------------------
	// get PROFILE DESCRIPTIONS
	//-----------------------------------------------------------
	refreshGraphDescriptions();

	/**
	 * remove User Defined PROFILE
	 */
	function removeUserDefinedProfile(profileName)
	{
		var sendObject = {
			productString:      "",
			userName:           "",
			profileName:        profileName,
			profileDescription: "",
			profileValue:       "", //  empty [] ARRAY, means DELETE the PROFILE NAME
			profileUrlOptions:  ""
		};
		console.log("removeUserDefinedProfile(): SEND_OBJ", sendObject);

		console.log("Removing PROFILE='"+profileName+"'.");
		$.ajax(
		{
			url: "/api/graph/profiles",
			type: 'POST',
			//async: false,   // to call it one by one (async: true = spawn away a bunch of them in the background)
			data: JSON.stringify(sendObject),
			contentType: "application/json; charset=UTF-8",

			success: function(data, status)
			{
				console.log("SUCCESS: POST[DELETE] /api/graph/profiles: ", data, status);

				// console.log("RECEIVED DATA: "+data);
				//var jsonResp = JSON.parse(data);

				// instead load the page from start... to reload the new Saved Profile(s)
				location.reload();
			},
			error: function(xhr, desc, err)
			{
				console.log(xhr);
				console.log("Details: " + desc + "\nError: " + err);
			}
		}); // end: ajax call
	}


	/**
	 * ---------------------------------------------------------------------------
	 * -- Daily Summary Report -- SKIP
	 * ---------------------------------------------------------------------------
	 */
	$.ajax(
	{
		url: "/api/dsr/skip",
		type: 'get',
		// async: false,   // to call it one by one (async: true = spawn away a bunch of them in the background)

		success: function(data, status)
		{
			// console.log("RECEIVED DATA: "+data);
			var jsonResp = JSON.parse(data);

//			let dsrSkipTableDiv = document.getElementById("dsr-skip-table");

//			let tab = jsonToTable(jsonResp, false);
//			dsrSkipTableDiv.innerHTML = "Found following SKIP Entries:<br>";
//			dsrSkipTableDiv.appendChild(tab);
//			dsrSkipTableDiv.appendChild(document.createElement("br"));

			var html_tab  = "<table class='table table-bordered table-hover table-sm data-sortable'> ";
			    html_tab += "  <thead> ";
			    html_tab += "    <tr>  ";
			    html_tab += "      <th>SrvName</th> ";
			    html_tab += "      <th>ClassName</th> ";
			    html_tab += "      <th>EntryType</th> ";
			    html_tab += "      <th>StringVal</th> ";
			    html_tab += "      <th>Action</th> ";
			    html_tab += "      <th>Description</th> ";
			    html_tab += "      <th>SqlTextExample</th> ";
			    html_tab += "    </tr> ";
			    html_tab += "  </thead> ";
			    html_tab += "  <tbody> ";

			for (var i=0; i<jsonResp.length; i++) {
				var entry = jsonResp[i];

//				var actionLink = "<a href=\"javascript:removeDsrEntry('" + entry.srvName + "', '" + entry.className + "', '" + entry.entryType + "', '" + entry.stringVal + "'); \")>delete</a>";
				var actionLink = "<button type='button' class='btn btn-danger btn-xs' onclick=\"removeDsrEntry('" + entry.srvName + "', '" + entry.className + "', '" + entry.entryType + "', '" + entry.stringVal + "');\">Delete</button>";

				// Build table
				html_tab += "    <tr>";
				html_tab += "      <td>" + entry.srvName        + "</td> ";
				html_tab += "      <td>" + entry.className      + "</td> ";
				html_tab += "      <td>" + entry.entryType      + "</td> ";
				html_tab += "      <td>" + entry.stringVal      + "</td> ";
				html_tab += "      <td>" + actionLink           + "</td> ";
				html_tab += "      <td>" + entry.description    + "</td> ";
				html_tab += "      <td><div style='width:600px; max-height:150px; overflow:auto'><xmp>" + entry.sqlTextExample + "</xmp></div></td> ";
				html_tab += "    </tr>";
			}
			html_tab += "  </tbody>";
			html_tab += "</table>";

			// set the table to div: dsr-skip-table
			let dsrSkipTableDiv = document.getElementById("dsr-skip-table");
			dsrSkipTableDiv.innerHTML = html_tab;

			// setting count
			document.getElementById("dbx-dsr-skip-count").innerHTML = jsonResp.length;
		},
		error: function(xhr, desc, err)
		{
			console.log(xhr);
			console.log("Details: " + desc + "\nError: " + err);
		}
	}); // end: ajax call

	function removeDsrEntry(srvName, className, entryType, stringVal)
	{
		console.log("DELETE: srvName='" + srvName + "', className='" + className + "', entryType='" + entryType + "', stringVal='" + stringVal + "'.");

		$.ajax(
		{
			url: "/api/dsr/skip?srvName=" + srvName + "&className=" + className + "&entryType=" + entryType + "&stringVal=" + stringVal,
			type: 'delete',
			// async: false,   // to call it one by one (async: true = spawn away a bunch of them in the background)

			success: function(data, status)
			{
				console.log("removeDsrEntry-RESPONSE:", data, status);
				window.location = window.location.pathname;
				//location.reload();
				//window.location = window.location.pathname + window.location.hash;
				//window.location.reload();
				//location.href = window.location.pathname + '#dbxc-dsr-skip';
				//location.reload(true);
			},
			error: function(xhr, desc, err)
			{
				console.log(xhr);
				console.log("Details: " + desc + "\nError: " + err);
			}
		}); // end: ajax call
	}

	// -------------- SAVE ---------------------
//	$('#dbx-dsr-skip-dialog').on('click', '.btn-ok', function(e)
	$("#dbx-dsr-skip-form").submit(function(e)
	{
//		var modalDiv = $(e.delegateTarget);
//		modalDiv.addClass('working');

		e.preventDefault(); // avoid to execute the actual submit of the form.

		var srvName        = document.getElementById("dbx-dsr-skip-srvName"       ).value;
		var className      = document.getElementById("dbx-dsr-skip-className"     ).value;
		var entryType      = document.getElementById("dbx-dsr-skip-entryType"     ).value;
		var stringVal      = document.getElementById("dbx-dsr-skip-stringVal"     ).value;
		var description    = document.getElementById("dbx-dsr-skip-description"   ).value;
		var sqlTextExample = document.getElementById("dbx-dsr-skip-sqlTextExample").value;

		var sendData = {
			srvName:         srvName,
			className:       className,
			entryType:       entryType,
			stringVal:       stringVal,
			description:     description,
			sqlTextExample:  sqlTextExample
		};

		console.log("SAVE Send JSON: ", sendData);
		document.getElementById("dbx-dsr-skip-error").innerHTML = "";

		// adding the below to the ajax request causes: error: Unexpected end of json input
		//dataType: 'json',
		//contentType: 'application/json',

		// send the update request
		$.ajax(
		{
			url: '/api/dsr/skip',
			type: 'post',
			data: JSON.stringify(sendData),
			success: function(data, status)
			{
				console.log("success.status: " + status);
				console.log("success.data: " + data);

				window.location = window.location.pathname;
				//location.reload();
				//window.location = window.location.pathname + window.location.hash;
				//window.location.reload();
				//location.href = window.location.pathname + '#dbxc-dsr-skip';
				//location.reload(true);
			},
			error: function(xhr, desc, err)
			{
				console.log("send error, xhr:", xhr);
				console.log("Details: " + desc + "\nError: " + err);

				var errorDiv = document.getElementById("dbx-dsr-skip-error");
				errorDiv.style.display = 'block';
				errorDiv.innerHTML = "Details: " + desc + "<br>Error: " + err;
			}
		});
	});

	// -------------- enable/disable "save" button ---------------------
	// https://stackoverflow.com/questions/58753515/bootstrap-4-validation-disable-submit-button-until-form-validated
	window.addEventListener('load', function()
	{
		let formVar = document.getElementById('dbx-dsr-skip-form');
		// Validate on input:
		formVar.querySelectorAll('.form-control').forEach((input, index) =>
		{
			input.addEventListener(('input'), () =>
			{
				console.log("Field ID='" + input.id + "', isValid=" + input.checkValidity());

				if (input.checkValidity()) {
					input.classList.remove('is-invalid')
					input.classList.add('is-valid');
				} else {
					input.classList.remove('is-valid')
					input.classList.add('is-invalid');
				}

				var inValidFieldsCount  = $('.form-control.is-invalid').length
				var isFormValid = (inValidFieldsCount === 0);

				$("#dbx-dsr-skip-save").attr("disabled", !isFormValid);

				console.log("FORM: 'dbx-dsr-skip-save': isFormValid=" + isFormValid + "[inValidFieldsCount=" + inValidFieldsCount + "]");
			});
		});

		// Validate on submit:
		formVar.addEventListener('submit', function(event)
		{
			if (formVar.checkValidity() === false)
			{
				event.preventDefault();
				event.stopPropagation();
			}
			formVar.classList.add('was-validated');
		}, false);
	});

	// -------------- OPEN DIALOG ---------------------
	$('#dbx-dsr-skip-dialog').on('show.bs.modal', function(e) {

		console.log("#dbx-dsr-skip-dialog: OPEN ");

		setTimeout(function() {
			console.log("Try to kick of field validation... by dispatchEvent: and a dummy input event");
			document.getElementById('dbx-dsr-skip-srvName')       .dispatchEvent(new Event('input',{bubbles: true, cancelable: true}));
			document.getElementById('dbx-dsr-skip-className')     .dispatchEvent(new Event('input',{bubbles: true, cancelable: true}));
			document.getElementById('dbx-dsr-skip-entryType')     .dispatchEvent(new Event('input',{bubbles: true, cancelable: true}));
			document.getElementById('dbx-dsr-skip-stringVal')     .dispatchEvent(new Event('input',{bubbles: true, cancelable: true}));
			document.getElementById('dbx-dsr-skip-description')   .dispatchEvent(new Event('input',{bubbles: true, cancelable: true}));
			document.getElementById('dbx-dsr-skip-sqlTextExample').dispatchEvent(new Event('input',{bubbles: true, cancelable: true}));
		}, 250);
	});

	// -------------- Check for input parameters ---------------------
	// if: op='openAddSkipEntry' --> open "skip" modal dialog
	// http://localhost:8080/admin/admin.html?op=openDsrSkipDialog=openAddSkipEntry&srvName=xxx&className=yyy&entryType=zzz&stringVal=aaa&description=bbb&sqlTextExample=ccc
	const param_op             = getParameter("op", '');
	console.log("Input Parameters: 'op' = |" + param_op + "|")
	if (param_op === 'openDsrSkipDialog')
	{
		const param_srvName        = getParameter("srvName",         '');
		const param_className      = getParameter("className",       '');
		const param_entryType      = getParameter("entryType",       '');
		const param_stringVal      = getParameter("stringVal",       '');
		const param_description    = getParameter("description",     '');
		const param_sqlTextExample = getParameter("sqlTextExample",  '');

		console.log("Input Parameters: 'param_srvName'        = |" + param_srvName        + "|")
		console.log("Input Parameters: 'param_className'      = |" + param_className      + "|")
		console.log("Input Parameters: 'param_entryType'      = |" + param_entryType      + "|")
		console.log("Input Parameters: 'param_stringVal'      = |" + param_stringVal      + "|")
		console.log("Input Parameters: 'param_description'    = |" + param_description    + "|")
		console.log("Input Parameters: 'param_sqlTextExample' = |" + param_sqlTextExample + "|")

		document.getElementById('dbx-dsr-skip-srvName')       .value = param_srvName;
		document.getElementById('dbx-dsr-skip-className')     .value = param_className;
		document.getElementById('dbx-dsr-skip-entryType')     .value = param_entryType;
		document.getElementById('dbx-dsr-skip-stringVal')     .value = param_stringVal;
		document.getElementById('dbx-dsr-skip-description')   .value = param_description;
		document.getElementById('dbx-dsr-skip-sqlTextExample').value = param_sqlTextExample;

		$('#dbx-dsr-skip-dialog').modal('show');
	}

	//-----------------------------------------------------------
	// Check for login and set props
	//-----------------------------------------------------------
	isLoggedIn( function(isLogedIn, asUserName)
	{
		console.log("isLoggedIn-callback: isLogedIn='"+isLogedIn+"', asUserName='"+asUserName+"'.");
	});

</script>
</body>
</html>
