<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<title>DbxTune - Central</title>

  <!-- 
    =======================================================================
    == JS imports - JAVA SCRIPTS GOES HERE
    =======================================================================
  -->
  <!-- JS: JQuery -->
  <script type="text/javascript" src="/scripts/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/scripts/jquery/ui/1.11.3/jquery-ui.min.js"></script>

  <!-- JS: Moment; used by: ChartJs, DateRangePicker -->
  <script type="text/javascript" src="/scripts/moment/moment.js"></script>
  <script type="text/javascript" src="/scripts/moment/moment-duration-format.js"></script>

  <!-- JS: Bootstrap -->
  <script type="text/javascript" src="/scripts/popper/1.12.9/popper.min.js"></script>
  <script type="text/javascript" src="/scripts/bootstrap/js/bootstrap.min.js"></script>

  <!-- JS: Selectize -->
  <script type="text/javascript" src="/scripts/selectize/js/standalone/selectize.js"></script>
  
  <!-- JS: DbxCentral -->
  <script type="text/javascript" src="/scripts/dbxcentral.utils.js"></script>

  <!-- 
    =======================================================================
    == CSS imports - STYLES SHEETS GOES HERE
    =======================================================================
  -->
  <!-- CSS: jqueri-ui -->
  <link rel="stylesheet" href="/scripts/jquery/ui/1.11.3/themes/smoothness/jquery-ui.css">

  <!-- CSS: DbxCentral -->
  <link rel="stylesheet" href="/scripts/css/dbxcentral.css">

  <!-- CSS: Bootstrap -->
  <link rel="stylesheet" href="/scripts/bootstrap/css/bootstrap.min.css">

  <!-- CSS: Font Awsome -->
  <link rel="stylesheet" href="/scripts/font-awesome/4.4.0/css/font-awesome.min.css">

  <!-- CSS: Selectize -->
  <!-- <link rel="stylesheet" href="/scripts/selectize/css/selectize.css"> -->
  <!-- <link rel="stylesheet" href="/scripts/selectize/css/selectize.default.css"> -->
  <!-- <link rel="stylesheet" href="/scripts/selectize/css/selectize.bootstrap3.css"> -->
  <link rel="stylesheet" href="/scripts/selectize/css/selectize.default.css">
 
  <!-- Local CSS -->
  <style type='text/css'>
    /* table {border-collapse: collapse;}
    th, td {border: 1px solid black; text-align: left; padding: 2px;}
    tr:nth-child(even) {background-color: #f2f2f2;} */
    .dbx-quick-access-tooltip-table table {border-collapse: collapse;}
    .dbx-quick-access-tooltip-table th, td {border: 1px solid white; text-align: left; padding: 2px;}

    .tooltip-inner { max-width: 1000px; }

    .jumbotron{ margin-top:-30px; }
	
	/* selectize selected items */
	.ui-sortable-handle {
		width: 100%;
	}
	.selectize-dropdown, .selectize-dropdown.form-control{
		height: 35vh !important;
	}
	.selectize-dropdown-content{
		max-height: 100% !important;
		height: 100% !important;
	}


  </style>

</head>

<body>
  <!-- NavBar that works, except for: iphone... -->
  <nav class="navbar navbar-expand-md navbar-dark sticky-top bg-dark mb-0">
    <a class="navbar-brand" href="/">DbxCentral</a>
    <!-- <a class="navbar-brand" href="#"><img style="	width: 32px;" src="images/dbxcentral_32.png">DbxCentral</a> -->
    <!-- <a class="navbar-brand" href="#"><img style="	width: 16px;" src="images/dbxcentral_16.png">DbxCentral</a> -->
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarCollapse">
      <ul class="navbar-nav mr-auto">
        <li class="nav-item">
          <a class="nav-link" href="/overview">Servers</a>
        </li>
        <li class="nav-item active">
          <a class="nav-link" href="/admin/admin.html">Admin</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/desktop_app.html">Desktop App</a>
        </li>
      </ul>
	  <!-- on the right hand side of the menu... -->
      <ul class="navbar-nav">
	    <!-- IS LOGGED IN -->
        <div id="dbx-nb-isLoggedIn-div" style="display: none;">
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="http://example.com" id="navbarDropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              <i class="fa fa-user"></i> <span id="dbx-nb-isLoggedInUser-div"></span> <!-- current username will be in here -->
            </a>
            <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdownMenuLink">
            <a class="dropdown-item" href="#"> <i class="fa fa-cog"></i> Settings [not-yet-implemented]</a>
            <a class="dropdown-item" href="/logout"> <i class="fa fa-sign-out"></i> Logout</a>
            </div>
          </li>
        </div>
	    <!-- IS LOGGED OUT -->
        <div id="dbx-nb-isLoggedOut-div">
          <a class="nav-link" href="/index.html?login"> <i class="fa fa-sign-in"></i> <span data-toggle="tooltip" title="Log in as a specific user.">Login</span></a>
        </div>
      </ul> <!-- end right hand side -->
    </div>
  </nav>
  
  <!-- Basic info + "QUICK ACCESS" buttons to server graphs... -->
  <main role="main" class="container">
    <div class="jumbotron">
      <h1>DbxTune - Administration</h1>
<!--
      <p class="lead">Administration of ...</p>
      <p></p>
-->
      <!-- - - - - - - - - - - - - - - - - - - - - - - - - - - -->
      <!-- DBMS Server Admin -->
      <!-- - - - - - - - - - - - - - - - - - - - - - - - - - - -->
      <div id='server-admin' class='card border-dark mb-3'>
        <h5 class='card-header'>DBMS Server Administration</h5>
        <div class='card-body'>

          <b>Add</b> a new DBMS server... (not yet implemented)
          <div id="dbx-add-server-div">
            <a class="btn btn-sm btn-primary mb-2" data-toggle="tooltip" data-placement="right" title="Open a dialog where you can add 'Servers' to the configuration." href="/admin?op=addServer&name=DUMMY_ASE" role="button">Add...</a>
          </div>

          <b>Remove</b> Any off the below servers... (a confirm dialog will be displayed)
          <div id="dbx-remove-server-list">
              <button type="button" class="btn btn-sm btn-primary">Loading server list <i class='fa fa-spinner fa-spin '></i></button>
          </div>
    
          <b>Disable</b> Any off the below servers... (it will not show up in the server list)
          <div id="dbx-disable-server-list">
              <button type="button" class="btn btn-sm btn-primary">Loading server list <i class='fa fa-spinner fa-spin '></i></button>
          </div>
    
          <b>Enable</b> Any off the below servers... (below list has been disabled)
          <div id="dbx-enable-server-list">
              <button type="button" class="btn btn-sm btn-primary">Loading server list <i class='fa fa-spinner fa-spin '></i></button>
          </div>
    
        </div>  <!-- end: card-body -->
      </div>  <!-- end: card -->

      <!-- - - - - - - - - - - - - - - - - - - - - - - - - - - -->
      <!-- Graph Profiles -->
      <!-- - - - - - - - - - - - - - - - - - - - - - - - - - - -->
      <div id='graph-profiles' class='card border-dark mb-3'>
        <h5 class='card-header'>Graph Profiles - What Graphs should be visible</h5>
        <div class='card-body'>
          <b>Change</b> any of System Profiles
          <div id="dbx-change-ssp-div">
            <div id="dbx-change-ssp-product-list">
              <button type="button" class="btn btn-sm btn-primary">Loading DbxProduct list <i class='fa fa-spinner fa-spin '></i></button>
            </div>
            <!--<a class="btn btn-sm btn-primary mb-2" data-toggle="tooltip" data-placement="right" title="Open a dialog where you can add/change Chart profiles." href="/admin?op=addServer&name=DUMMY_ASE" role="button">Add/Change Profile...</a>-->
    <!--		
    		<div class="sandbox">
    			<label for="input-draggable">XXXXXXXXXXXX:</label>
    			<input type="text" id="input-draggable" class="demo-default" placeholder="Type to Search...">
    		</div>
    -->
          </div>

          <b>Remove</b> any User Defined Profiles (<b>Warning: NO Confirm dialog!</b>)
          <div id="dbx-removeUdp-div">
            <div id="dbx-removeUdp-list">
              <button type="button" class="btn btn-sm btn-primary">Loading User Defined Profile list <i class='fa fa-spinner fa-spin '></i></button>
            </div>
          </div>

          <b>Add</b> any User Defined Profiles
          <div id="dbx-addUdg-div">
            <a class="btn btn-sm btn-primary" data-toggle="tooltip" data-placement="right" title="Open the main page." href="/" role="button">This is done from the "main" page...</a>
          </div>
        </div>  <!-- end: card-body -->
      </div>  <!-- end: card -->

      <!-- - - - - - - - - - - - - - - - - - - - - - - - - - - -->
      <!-- DBX Central Admin -->
      <!-- - - - - - - - - - - - - - - - - - - - - - - - - - - -->
      <div id='dbxc-admin' class='card border-dark mb-3'>
        <h5 class='card-header'>DbxCentral Administration</h5>
        <div class='card-body'>
          <b>Restart</b> DbxCentral
          <div id="dbx-restart-server-div">
            <!-- <a class="btn btn-sm btn-primary mb-2" onclick="restartServer()" role="button">Restart</a> -->
            <button type="button" class="btn btn-sm btn-primary" data-toggle="tooltip" data-placement="bottom" title="Restart the DbxCentral server instance. no collectors will be restarted." onclick="restartServer('normal')">Restart</button>
            <button type="button" class="btn btn-sm btn-primary" data-toggle="tooltip" data-placement="bottom" title="Restart the DbxCentral server instance, and do database 'compact'. no collectors will be restarted." onclick="restartServer('compact')">Restart (with compact)</button>
            <button type="button" class="btn btn-sm btn-primary" data-toggle="tooltip" data-placement="bottom" title="Restart the DbxCentral server instance, and do database 'defrag'. no collectors will be restarted." onclick="restartServer('defrag')">Restart (with defrag)</button>
            <!-- <span id="dbx-server-restart-spinner"><img src="/images/busy_spinner.gif" height="32" width="32"></span> -->
            <span id="dbx-server-restart-feedback"></span>
            <span id="dbx-server-restart-spinner"><img src="/images/ajax-loader.gif"></span>
          </div>
    
          <br>
          <b>Logout</b> as 'admin'
          <div id="dbx-logout-div">
<!--            <button class="btn btn-sm mb-2" data-toggle="tooltip" data-placement="right" title="Logout" onclick="logout()">Logout</button>-->
            <a class="btn btn-sm mb-2 btn-primary" data-toggle="tooltip" data-placement="right" title="Logout" href="/logout" role="button">Logout</a>
          </div>
        </div>  <!-- end: card-body -->
      </div>  <!-- end: card -->

      <!-- - - - - - - - - - - - - - - - - - - - - - - - - - - -->
      <!-- DBX User(s) Admin -->
      <!-- - - - - - - - - - - - - - - - - - - - - - - - - - - -->
      <div id='dbxc-user' class='card border-dark mb-3'>
        <h5 class='card-header'>User Administration</h5>
        <div class='card-body'>
          <b>Add</b> User - Done in the main window
    
          <br>
          <b>Change</b> User (Password or Roles) - Not yet implemented

          <br>
          <b>Remove</b> User - Not yet implemented

        </div>  <!-- end: card-body -->
      </div>  <!-- end: card -->
	  
    </div>
  </main>

  <!-- Error message: browser support -->
  <div id="browser-not-supported"></div>

  <div id="delete-result"></div>


  <!-- Modal: Confirm dialog -->
  <div class="modal fade" id="dbx-confirm-delete-dialog" tabindex="-1" role="dialog" aria-labelledby="dbx-confirm-delete-dialog" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="dbx-confirm-delete-dialog-title"><b>WARNING:</b> Removal of server '<b class="title"></b>' is irreversible</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          When removing the server, the following will be done.
          <ul>
            <li>Remove Server from Dbx Central Meta Data tables.</li>
            <li>Remove Server Data from Dbx Central database (db schema '<b class="title"></b>').</li>
            <li>Remove all DBMS recording(s), <i>H2 database files</i></li>
            <li>Remove Server from <code>conf/SERVER_LIST</code></li>
            <li>Remove Log files for the Server</li>
          </ul>
          A report will show, what was possible to remove (if you press: Remove)
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          <button type="button" class="btn btn-danger btn-ok">Remove Server</button>
        </div>
      </div>
    </div>
  </div>  


  <!-- Modal Dialog: Change System Supplied Profiles for Graphs -->
  <div class="modal fade" id="dbx-change-ssp-dialog" tabindex="-1" role="dialog" aria-labelledby="dbx-change-ssp-dialog" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="dbx-change-ssp-dialog-title">Changing Graph Profile for '<b class="title"></b>'</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          Things you can do in this dialog
          <ul>
            <li><b>Add a graph</b> - Click the 'Add...' button, or select the input field, then type what you search for...</li>
            <li><b>Remove a graph</b> - Simply press the 'x' on the Graph Item</li>
            <li><b>Reorder graph display order</b> - Do <i>drag & drop</i></li>
            <li><b>Reset this profile</b> - Remove all entries and press 'Save'</li>
          </ul>
          <input type="text" id="dbx-change-ssp-input" class="demo-default" placeholder="Type to Search...">
          <span id="dbx-change-ssp-dialog-select-cnt">X</span> Graphs selected, <span id="dbx-change-ssp-dialog-available-cnt">Y</span> available Graphs
          <span><button type="button" class="btn btn-default btn-sm btn-add">Add...</button></span>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary btn-ok">Save</button>
        </div>
      </div>
    </div>
  </div>  


<script>
  // Global variables
  var _graphDesc = [];

  // Hide spinner at start
  $('#dbx-server-restart-spinner').hide();

  $('#dbx-confirm-delete-dialog').on('click', '.btn-ok', function(e) {
      var modalDiv = $(e.delegateTarget);
      var serverName = $(this).data('recordId');
      console.log("#dbx-confirm-delete-dialog: serverName: "+serverName);
      modalDiv.addClass('working');
      removeServer(serverName, modalDiv);
      // $.ajax({url: '/api/record/' + id, type: 'DELETE'})
      // $.post('/api/record/' + id).then()
      // setTimeout(function() {
      //     modalDiv.modal('hide').removeClass('working');
      // }, 1000)
  });
  $('#dbx-confirm-delete-dialog').on('show.bs.modal', function(e) {
      var data = $(e.relatedTarget).data();
      console.log("#dbx-confirm-delete-dialog: data.recordId: "+data.recordId);
      $('.title', this).text(data.recordTitle);
      $('.btn-ok', this).data('recordId', data.recordId);
  });

  
	$('#dbx-change-ssp-dialog').on('click', '.btn-add', function(e) {
		var selectize = $('#dbx-change-ssp-input').selectize()[0].selectize;
		selectize.open();
	});
	$('#dbx-change-ssp-dialog').on('click', '.btn-ok', function(e) {
		var modalDiv = $(e.delegateTarget);
		var dbxProduct = $(this).data('recordId');
		console.log("#dbx-change-ssp-dialog: dbxProduct: "+dbxProduct);
		modalDiv.addClass('working');

		var selectize = $('#dbx-change-ssp-input').selectize()[0].selectize;
		var selectedItems = $.map(selectize.items, function(value) {
			return selectize.options[value];
		});
		console.log("#dbx-change-ssp-dialog: selectedItems: "+selectedItems, selectedItems);
		console.log("#dbx-change-ssp-dialog: selectize.items: "+selectize.items, selectize.items);

		// construct JSON TO Send: [ {graph:"fullGraphName1"}, {graph:"fullGraphName2"}, {graph:"fullGraphName3"}... ]
		var selectedJson = $.map(selectize.items, function(value) {
			return { graph: value };
		});
		console.log("#dbx-change-ssp-dialog: selectedJson: "+selectedJson, selectedJson);
		
		var sendData = {
			productString:      dbxProduct,
			userName:           '',
			profileType:        'SYSTEM_SELECTED',
			profileName:        '',
			profileDescription: '',
			profileValue:       selectedJson,
			profileUrlOptions:  ''
		};
		
		// send the update request
		$.ajax({
//			url: '/api/graph/profiles/' + dbxProduct, 
			url: '/api/graph/profiles?dbxProduct='+dbxProduct, 
			type: 'post',
			dataType: 'json',
			contentType: 'application/json',
			data: JSON.stringify(sendData),
			success: function(data, status) {
				console.log("success.status: " + status);
				console.log("success.data: " + data);
				
				setTimeout(function() {
					refreshGraphDescriptions();
					modalDiv.modal('hide').removeClass('working');
				}, 10);
			},
			error: function(xhr, desc, err) 
			{
				console.log(xhr);
				console.log("Details: " + desc + "\nError: " + err);
			}
		});
		
		// removeServer(dbxProduct, modalDiv);
		// $.ajax({url: '/api/record/' + id, type: 'DELETE'})
		// $.post('/api/record/' + id).then()
		// setTimeout(function() {
		//     modalDiv.modal('hide').removeClass('working');
		// }, 1000)
	});
	$('#dbx-change-ssp-dialog').on('show.bs.modal', function(e) {
		var data = $(e.relatedTarget).data();
		var dbxProduct = data.recordId;

		console.log("#dbx-change-ssp-dialog: dbxProduct: "+dbxProduct);

		var ssp = _graphDesc[dbxProduct];
		
		// Get all 'tableName' entries from SSP System Selected Profile
		let sspEntries = ssp._SSP_.map(a => a.tableName);

//		console.log("#dbx-change-ssp-dialog: preSelectedEntries: "+sspEntries, sspEntries);
//		console.log("#dbx-change-ssp-dialog: ALL.length: "+ssp._ALL_.length);

//		var selectize = $('#dbx-change-ssp-input').selectize()[0].selectize;
////		selectize.options = ssp._ALL_;
////		selectize.items   = sspEntries;
//
//		selectize.clearOptions();
//		selectize.addOption(ssp._ALL_);
////		selectize.refreshOptions();
//		
//		selectize.clear();
////		selectize.addItem(sspEntries);
////		selectize.refreshItems();
//		selectize.setValue(sspEntries);


		$('#dbx-change-ssp-input').selectize()[0].selectize.destroy();
		$('#dbx-change-ssp-input').selectize({
			plugins: ['drag_drop', 'remove_button'],
			create: false, // do not allow new entries
			persist: false,
			maxItems: null,
			valueField: 'tableName',
			searchField: ['cmName', 'graphName', 'graphLabel', 'graphCategory'],
			options: ssp._ALL_,
			items:   sspEntries,
			onItemAdd: function(value, item) {
				//console.log("onItemAdd()", value, item);
				setGraphCountSelection();
			},
			onItemRemove: function(value) {
				//console.log("onItemRemove()", value);
				setGraphCountSelection();
			},
			render: {
				item: function(item, escape) {
					//console.log("render.item()", item);
					return '<div>' +
						'<span>' + escape(item.cmName) + '</span>' +
						' - <span>' + escape(item.graphName) + '</span>' +
						' - <span><i>' + escape(item.graphCategory) + '</span></i>' +
						'<br><span><b>' + escape(item.graphLabel) + '</b></span>' +
					'</div>';
				},
				option: function(item, escape) {
					//console.log("render.option()", item);
					return '<div>' +
						'<span>' + escape(item.cmName) + '</span>' +
						' - <span>' + escape(item.graphName) + '</span>' +
						' - <span><i>' + escape(item.graphCategory) + '</i></span>' +
						' - <span><b>' + escape(item.graphLabel) + '</b></span>' +
					'</div>';
				}
			}
		});
		$('#dbx-change-ssp-input').selectize()[0].selectize.setValue(sspEntries);
//		$('#dbx-change-ssp-input').selectize()[0].selectize.refreshOptions();
//		$('#dbx-change-ssp-input').selectize()[0].selectize.refreshItems();
	  
		setGraphCountSelection();

	  $('.title', this).text(dbxProduct);
      $('.btn-ok', this).data('recordId', dbxProduct);
  });
  
  /**
   * set "#dbx-change-ssp-dialog-select-cnt" and "#dbx-change-ssp-dialog-available-cnt"
   */
  function setGraphCountSelection() 
  {
	let selectedItems   = $('#dbx-change-ssp-input').selectize()[0].selectize.items.length;
	let availableItems  = $('#dbx-change-ssp-input').selectize()[0].selectize.order;
	let unSelectedItems = availableItems - selectedItems;
	
	$("#dbx-change-ssp-dialog-select-cnt")   .text( selectedItems );
	$("#dbx-change-ssp-dialog-available-cnt").text( availableItems );
//	$("#dbx-change-ssp-dialog-unselected-cnt").text( unSelectedItems );
  }
  
  /**
   * Restart server
   */
  function waitforRestartServer() 
  {
    $.ajax(
    {
      //url: "/dummyfile.html",
      url: "/dummy", // a servlet is called dummy
      type: 'get',
      //async: false,   // to call it one by one (async: true = spawn away a bunch of them in the background)
      
      success: function(data, status) 
      {
        $('#dbx-server-restart-spinner').hide();
        $('#dbx-server-restart-feedback').text('Server restarted!').fadeOut(3000);
        console.log("Content.status: " + status);
        console.log("Content: " + data);
      },
      error: function(xhr, desc, err) 
      {
        console.log(xhr);
        console.log("Details: " + desc + "\nError: " + err);

        let feedbackDiv = document.getElementById('dbx-server-restart-feedback');
        feedbackDiv.innerHTML += '.';

        setTimeout(waitforRestartServer, 1000);
      }
    }); // end: ajax call
  }

  /**
   * Restart server
   */
  function restartServer(restartType) 
  {
    var urlParams="&h2ShutdownType=IMMEDIATELY";
    if (restartType === "compact")
    {
      urlParams="&h2ShutdownType=COMPACT";
    }
    else if (restartType === "defrag")
    {
      urlParams="&h2ShutdownType=DEFRAG";
    }

    $.ajax(
    {
      url: "/admin/shutdown?password=secret&restart"+urlParams,
      type: 'get',
      //async: false,   // to call it one by one (async: true = spawn away a bunch of them in the background)
      
      success: function(data, status) 
      {
        $('#dbx-server-restart-spinner').show();
        $('#dbx-server-restart-feedback').text("Waiting for restart...").show();
        setTimeout(waitforRestartServer, 4000);
      },
      error: function(xhr, desc, err) 
      {
        console.log(xhr);
        console.log("Details: " + desc + "\nError: " + err);
        $('#dbx-server-restart-feedback').text("Connect to server failed: "+err).show();
      }
    }); // end: ajax call
  }


  // function removeServerConfirmDialog(serverName)
  // {
  //   $("#dbx-confirm-delete-dialog").modal("show");
  // }

  function setServerStatus(action, serverName)
  {
    console.log("setServerStatus: action='"+action+"', serverName='"+serverName+"'.");
    // alert("setServerStatus: action='"+action+"', serverName='"+serverName+"'.");

    $.ajax(
    {
      url: "/admin?op="+action+"Server&name="+serverName,
      type: 'get',
      async: false,   // to call it one by one (async: true = spawn away a bunch of them in the background)
      
      success: function(data, status) 
      {
        var jsonResp = JSON.parse(data);
        var actions = jsonResp.actions;
        console.log("actions: "+actions, actions);

        var tab = "<table class='table table-hover'>";
        tab += "<thead class='thead-light'><tr>";
        tab += "  <th scope='col'>Action</th>";
        tab += "  <th scope='col'>Status</th>";
        tab += "  <th scope='col'>Message</th>";
        tab += "</tr></thead>";
        tab += "<tbody>";
        for (var key in actions) {
          if (actions.hasOwnProperty(key)) {
            tab += "<tr>";
            tab += "  <td nowrap scope='row'>"+key+"</td>";
            tab += "  <td nowrap>"+actions[key].status+"</td>";
            tab += "  <td nowrap>"+actions[key].message+"</td>";
            tab += "</tr>";
          }
        }
        tab += "</tbody>";
        tab += "</table>";

        var refreshBut = '<a class="btn btn-sm btn-primary mb-2" href="/admin/admin.html" role="button">Refresh Page...</a>';
        var deleteResultDiv = document.getElementById("delete-result");
        deleteResultDiv.innerHTML = "<p>Results when changing status for: <b>"+serverName+"</b></p>"+tab+"<br>"+refreshBut;
      },
      error: function(xhr, desc, err) 
      {
        console.log(xhr);
        console.log("Details: " + desc + "\nError: " + err);

        alert("Error: action='"+action+"', serverName='"+serverName+"'. Details: " + desc + "\nError: " + err);
      }
    }); // end: ajax call

  }

  /**
   * remove Server
   */
  function removeServer(serverName, modalDiv)
  {
    console.log("Removing Server: "+serverName);
    $.ajax(
    {
      url: "/admin?op=removeServer&name="+serverName,
      type: 'get',
      //async: false,   // to call it one by one (async: true = spawn away a bunch of them in the background)
      
      success: function(data, status) 
      {
        modalDiv.modal('hide').removeClass('working');

        var jsonResp = JSON.parse(data);
        var actions = jsonResp.actions;
        console.log("actions: "+actions, actions);

        // var tab = jsonToTable(jsonResp.actions);
        var tab = "<table class='table table-hover'>";
        tab += "<thead class='thead-light'><tr>";
        tab += "  <th scope='col'>Action</th>";
        tab += "  <th scope='col'>Status</th>";
        tab += "  <th scope='col'>Message</th>";
        tab += "</tr></thead>";
        tab += "<tbody>";
        for (var key in actions) {
          if (actions.hasOwnProperty(key)) {
            // console.log(key + " -> " + actions[key]);
            tab += "<tr>";
            tab += "  <td nowrap scope='row'>"+key+"</td>";
            tab += "  <td nowrap>"+actions[key].status+"</td>";
            tab += "  <td nowrap>"+actions[key].message+"</td>";
            tab += "</tr>";
          }
        }
        tab += "</tbody>";
        tab += "</table>";

        var refreshBut = '<a class="btn btn-sm btn-primary mb-2" href="/admin/admin.html" role="button">Refresh Page...</a>';
        var deleteResultDiv = document.getElementById("delete-result");
        deleteResultDiv.innerHTML = "<p>Results when removing: <b>"+serverName+"</b></p>"+tab+"<br>"+refreshBut;
      },
      error: function(xhr, desc, err) 
      {
        console.log(xhr);
        console.log("Details: " + desc + "\nError: " + err);
      }
    }); // end: ajax call
  }
  
  /**
   * logout from basic authentication...
   * simply make a "dummy" call with a not existing user
   */
/*
  function logout()
  {
    console.log("logout...");
    $.ajax(
    {
      url: "/admin/admin.html",
      type: "get",
      dataType: 'json',
      async: true,
      username: "some_username_that_doesnt_exist",
      password: "any_stupid_password",
      data: '{ "dummy" }'
    })
    //In our case, we WANT to get access denied, so a success would be a failure.
    .done(function() {
      alert('Error, when trying to logout...')
    })
    //Likewise, a failure *usually* means we succeeded.
    //set window.location to redirect the user to wherever you want them to go
    .fail(function() {
      window.location = "/";
    });
  }
*/

  /**
   * refresh Graph Descriptions
   */
  function refreshGraphDescriptions()
  {
 	$.ajax(
 	{
		url: "/api/graph/description",
		type: 'get',
		// async: false,   // to call it one by one (async: true = spawn away a bunch of them in the background)

		success: function(data, status) 
		{
			// console.log("RECEIVED DATA: "+data);
			var jsonResp = JSON.parse(data);

			_graphDesc = jsonResp;
			console.log("refreshGraphDescriptions(): new values for _graphDesc.", _graphDesc);
		},
		error: function(xhr, desc, err) 
		{
			console.log(xhr);
			console.log("Details: " + desc + "\nError: " + err);
		}
	}); // end: ajax call
  }

  //-----------------------------------------------------------
  // get SERVERS
  //-----------------------------------------------------------
	$.ajax(
	{
    url: "/api/sessions",
		type: 'get',
		// async: false,   // to call it one by one (async: true = spawn away a bunch of them in the background)
		
		success: function(data, status) 
		{
			// console.log("RECEIVED DATA: "+data);
			var jsonResp = JSON.parse(data);

			const dbxProducts = [...new Set(jsonResp.map(item => item.productString))];
			//console.log("DbxProducts:", dbxProducts);
			
			var htmlRemove  = "";
			var htmlEnable  = "";
			var htmlDisable = "";
			for (var i=0; i<jsonResp.length; i++) 
			{
				var entry = jsonResp[i];

				var lastSampleTimeDuration = moment.duration(moment().diff(entry.lastSampleTime));
				var lastSampleWarnThresh   = 5; // # minutes

				var tt =
				"<table class='table table-sm'>"+
				"  <tr> <th nowrap colspan='2'>"+entry.serverDescription+"</th> </tr>"+
				"  <tr> <td nowrap>DBMS Server Name  </td> <td nowrap>"+ entry.serverName              +"</td> </tr>"+
				"  <tr> <td nowrap>DBMS On Hostname  </td> <td nowrap>"+ entry.onHostname              +"</td> </tr>"+
				"  <tr> <td nowrap>Collector         </td> <td nowrap>"+ entry.productString           +"</td> </tr>"+
				"  <tr> <td nowrap>Collector Hostname</td> <td nowrap>"+ entry.collectorHostname       +"</td> </tr>"+
				"  <tr> <td nowrap>Collector Interval</td> <td nowrap>"+ entry.collectorSampleInterval +"</td> </tr>"+
				"  <tr> <td nowrap>Last Sample       </td> <td nowrap>"+ moment(entry.lastSampleTime).format("YYYY-MM-DD HH:mm:ss") + (lastSampleTimeDuration.asMinutes() < lastSampleWarnThresh ? "" : ", <font color='red'>"+lastSampleTimeDuration.format()+"</font> since last sample" ) + "</td> </tr>"+
				"</table>";
				// The above tooltip didn't render that well (the table was wider than the "popup", which made it unreadable)
				// overide: .tooltip-inner { max-width: 1000px; } in the CSS and it worked better
				// tt = entry.serverDescription;

				// set button class depending on how long ago since we got any sample for this server
				var btnClass="btn-danger";
				// if (lastSampleTimeDuration.asMinutes() >= lastSampleWarnThresh)
				//     btnClass="btn-warning";

				var btnClass="btn-danger";
				var dbxButtonImage="dbx-button-image dbx-button-"+entry.productString.toLowerCase();

				htmlRemove  += '<span data-toggle="tooltip" data-placement="top" data-html="true" title="'+tt+'"><button type="button" class="btn btn-sm btn-danger '+dbxButtonImage+'  mb-2 mr-2" data-record-id="'+entry.serverName+'" data-record-title="'+entry.serverName+'" data-toggle="modal" data-target="#dbx-confirm-delete-dialog">'+entry.serverName+'</button></span>';
				if ((parseInt(entry.status) & 1) === 1) // 1=DISABLED
					htmlEnable  += '<span data-toggle="tooltip" data-placement="top" data-html="true" title="'+tt+'"><button type="button" class="btn btn-sm btn-primary '+dbxButtonImage+'  mb-2 mr-2" onclick=\'setServerStatus("enable",  "'+entry.serverName+'")\'>'+entry.serverName+'</button></span>';
				else
					htmlDisable += '<span data-toggle="tooltip" data-placement="top" data-html="true" title="'+tt+'"><button type="button" class="btn btn-sm btn-primary '+dbxButtonImage+'  mb-2 mr-2" onclick=\'setServerStatus("disable", "'+entry.serverName+'")\'>'+entry.serverName+'</button></span>';          
			}
			if (htmlRemove  === "") htmlRemove  = '<button type="button" class="btn btn-sm btn-primary mb-2 mr-2">NO-SERVERS-HAS-YET-BEEN-ADDED</button>';
			if (htmlDisable === "") htmlDisable = '<button type="button" class="btn btn-sm btn-primary mb-2 mr-2">No Servers Found</button>';
			if (htmlEnable  === "") htmlEnable  = '<button type="button" class="btn btn-sm btn-primary mb-2 mr-2">No Servers Found</button>';

			$('#dbx-remove-server-list').html(htmlRemove);
			$('#dbx-disable-server-list').html(htmlDisable);
			$('#dbx-enable-server-list').html(htmlEnable);

			// Enable bootstrap tooltip...
			$('[data-toggle="tooltip"]').tooltip();

			// Add buttons for: 'change' System Supplied Profiles
			var htmlSsp  = "";
			for (var i=0; i<dbxProducts.length; i++) 
			{
				var entry = dbxProducts[i];
				console.log("DbxProducts["+i+"]:", entry);

				var dbxButtonImage="dbx-button-image dbx-button-"+entry.toLowerCase();

//				htmlSsp += '<span><button type="button" class="btn btn-sm btn-primary '+dbxButtonImage+'  mb-2 mr-2" onclick=\'openChangeSspDialog("'+entry+'")\'>'+entry+'</button></span>';
				htmlSsp += '<span><button type="button" class="btn btn-sm btn-primary '+dbxButtonImage+'  mb-2 mr-2" data-record-id="'+entry+'" data-record-title="'+entry+'" data-toggle="modal" data-backdrop="static" data-target="#dbx-change-ssp-dialog">'+entry+'</button></span>';
			}
			if (htmlSsp === "") 
				htmlSsp = '<button type="button" class="btn btn-sm btn-primary mb-2 mr-2">No DbxProduct Found</button>';
			$('#dbx-change-ssp-product-list').html(htmlSsp);
		},
		error: function(xhr, desc, err) 
		{
			console.log(xhr);
			console.log("Details: " + desc + "\nError: " + err);
		}
  }); // end: ajax call
  
	//-----------------------------------------------------------
	// get PROFILES
	//-----------------------------------------------------------
	$.ajax(
	{
		url: "/api/graph/profiles",
		type: 'get',
		// async: false,   // to call it one by one (async: true = spawn away a bunch of them in the background)

		success: function(data, status) 
		{
			// console.log("RECEIVED DATA: "+data);
			var jsonResp = JSON.parse(data);

			var html = "";
			for (var i=0; i<jsonResp.length; i++) {
				var entry = jsonResp[i];

				if (entry.profileName === "")
					continue;
//				html += '<a class="btn btn-sm btn-danger mb-2 mr-2" href="/api/FIXME?profileName='+entry.profileName+'" role="button">'+entry.profileName+'</a>';
				html += '<button type="button" class="btn btn-sm btn-danger mb-2 mr-2" onclick=\'removeUserDefinedProfile("'+entry.profileName+'")\'>'+entry.profileName+'</button>';
			}
			if (html === "") 
				html = '<button type="button" class="btn btn-sm btn-primary mb-2 mr-2">No User Defined Profiles was Found</button>';
			$('#dbx-removeUdp-list').html(html);
		},
		error: function(xhr, desc, err) 
		{
			console.log(xhr);
			console.log("Details: " + desc + "\nError: " + err);
		}
	}); // end: ajax call
  
	//-----------------------------------------------------------
	// get PROFILE DESCRIPTIONS
	//-----------------------------------------------------------
	refreshGraphDescriptions();
   
	/**
	 * remove User Defined PROFILE
	 */
	function removeUserDefinedProfile(profileName)
	{
		var sendObject = {
			productString:      "",
			userName:           "",
			profileName:        profileName,
			profileDescription: "",
			profileValue:       "", //  empty [] ARRAY, means DELETE the PROFILE NAME
			profileUrlOptions:  ""
		};
		console.log("removeUserDefinedProfile(): SEND_OBJ", sendObject);
		
		console.log("Removing PROFILE='"+profileName+"'.");
		$.ajax(
		{
			url: "/api/graph/profiles",
			type: 'POST',
			//async: false,   // to call it one by one (async: true = spawn away a bunch of them in the background)
			data: JSON.stringify(sendObject),
			contentType: "application/json; charset=UTF-8",

			success: function(data, status) 
			{
				console.log("SUCCESS: POST[DELETE] /api/graph/profiles: ", data, status);
				
				// console.log("RECEIVED DATA: "+data);
				//var jsonResp = JSON.parse(data);

				// instead load the page from start... to reload the new Saved Profile(s)
				location.reload();
			},
			error: function(xhr, desc, err) 
			{
				console.log(xhr);
				console.log("Details: " + desc + "\nError: " + err);
			}
		}); // end: ajax call
	}
   

	//-----------------------------------------------------------
	// Check for login and set props
	//-----------------------------------------------------------
	isLoggedIn( function(isLogedIn, asUserName) 
	{
		console.log("isLoggedIn-callback: isLogedIn='"+isLogedIn+"', asUserName='"+asUserName+"'.");
	});
	
</script>
</body>
</html>
